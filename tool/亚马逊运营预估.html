<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Simulator v2.1 (Stable)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 基础变量 --- */
        :root {
            --bg-color: #f0f4f8; 
            --card-bg: #ffffff; 
            --primary: #2c3e50; 
            --accent: #3498db;
            --success: #27ae60; 
            --warning: #f39c12; 
            --danger: #e74c3c; 
            --purple: #8e24aa;
            --text-main: #34495e; 
            --text-light: #7f8c8d; 
            --input-bg: #fffde7; 
            --radius-md: 12px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 5px 15px rgba(0,0,0,0.08);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding: 20px; 
            font-size: 14px;
        }

        /* --- 布局网格 --- */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr; 
            gap: 20px;
            align-items: start;
        }

        .left-sidebar { display: flex; flex-direction: column; gap: 15px; }
        .right-content { display: flex; flex-direction: column; gap: 20px; }
        .top-metrics-grid { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 15px; }

        /* --- 通用组件 --- */
        .card { 
            background: var(--card-bg); 
            border-radius: var(--radius-md); 
            padding: 15px; 
            box-shadow: var(--shadow-sm); 
            border: 1px solid #fff; 
            transition: all 0.3s ease;
        }
        .card:hover { box-shadow: var(--shadow-hover); }

        h2 { 
            font-size: 14px; margin: 0 0 12px 0; color: var(--primary); 
            font-weight: 700; display: flex; align-items: center; 
            border-left: 4px solid var(--accent); padding-left: 10px; height: 18px; line-height: 18px;
        }

        /* --- 输入框 --- */
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-size: 12px; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
        .input-wrapper { display: flex; align-items: center; gap: 3px; }
        .input-field { 
            flex: 1; width: 100%; padding: 0 4px; border: 1px solid #e0e0e0; 
            background: var(--input-bg); border-radius: 4px; font-size: 12px; font-weight: 600; 
            text-align: right; color: #333; transition: all 0.2s; box-sizing: border-box;
            height: 28px; line-height: 26px;
        }
        .input-field:focus { outline: none; border-color: var(--accent); background: #fff; }
        .input-field-compact { font-size: 11px !important; padding: 0 2px !important; }
        .input-unit { position: static; font-size: 11px; color: #999; font-weight: normal; white-space: nowrap; min-width: 10px; }
        .usd-preview { font-size: 11px; color: var(--accent); text-align: right; margin-top: 2px; font-weight: 600; font-family: monospace; }

        /* --- 顶部栏 --- */
        .manager-bar {
            grid-column: 1 / -1; background: #fff; padding: 10px 20px; 
            border-radius: var(--radius-md); box-shadow: var(--shadow-sm); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .manager-left, .manager-right { display: flex; gap: 10px; align-items: center; }
        .prod-name-input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; width: 200px; font-size: 12px; }
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; color: #fff; }
        .btn-save { background: var(--accent); } 
        .btn-new { background: var(--warning); }
        .btn-io { background: #607d8b; } 
        .btn-excel { background: var(--success); }

        /* --- Plan A/B --- */
        .result-card-header { text-align: center; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px dashed #eee; }
        .price-display { font-size: 40px; font-weight: 800; color: var(--primary); line-height: 1.1; margin: 5px 0; }
        .actual-input { 
            font-size: 40px; font-weight: 800; color: var(--primary); width: 100%; 
            text-align: center; border: none; border-bottom: 2px dashed #bdc3c7; 
            background: transparent; padding: 0; font-family: inherit; margin: 5px 0;
        }
        .actual-input:focus { outline: none; border-bottom: 2px solid var(--primary); }
        .margin-display { font-size: 12px; color: var(--text-light); }
        .margin-val { font-weight: bold; color: var(--success); }
        .pnl-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .pnl-table td { padding: 4px 0; border-bottom: 1px dashed #f5f5f5; }
        .row-name { display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .row-val { text-align: right; font-weight: 600; }
        .row-pct { text-align: right; width: 35px; color: #999; font-size: 11px; }
        .progress-track { background: #f0f0f0; height: 4px; border-radius: 2px; width: 30px; margin-left: 5px; }
        .progress-fill { height: 100%; border-radius: 2px; }

        /* --- 底部数据展示区域 --- */
        .footer-highlight {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; align-items: start;
            font-size: 12px; color: #7f8c8d; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;
        }
        .fh-item { display: flex; flex-direction: column; align-items: center; text-align: center; border-right: 1px solid #eee; }
        .fh-item:last-child { border-right: none; }
        .fh-label { font-size: 10px; color: #999; margin-bottom: 4px; white-space: nowrap; }
        .fh-val { font-weight: 700; color: #34495e; font-family: -apple-system, monospace; font-size: 14px; }
        
        .c-prod { background: #3498db; } .c-log { background: #9b59b6; } .c-fba { background: #95a5a6; }
        .c-comm { background: #f39c12; } .c-ret { background: #e74c3c; } .c-ads { background: #f1c40f; } .c-prof { background: #2ecc71; }

        /* --- 广告模拟 (紧凑版) --- */
        .ad-input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .ad-input-box label { font-size: 10px; color: #888; display: block; }
        .ad-input-box input { width: 100%; padding: 4px; border: 1px solid #ddd; background: #fff; border-radius: 4px; font-weight: bold; text-align: center; font-size: 12px;}
        .ad-data-table { font-size: 12px; width: 100%; border-collapse: collapse; }
        .ad-data-table td { padding: 2px 0; border-bottom: 1px dashed #eee; }
        .ad-data-table tr:last-child td { border-bottom: none; }
        .ad-val { font-family: monospace; font-weight: bold; }
        .ad-row-title { color: #666; }
        .ad-val-price { color: #333; }
        .ad-val-cost { color: #e67e22; }
        .ad-val-profit { color: #3498db; }

        /* --- Mixer Section (流量沙盘) --- */
        .mixer-section { background: #fff; border-radius: var(--radius-md); padding: 15px; border: 1px solid #c5cae9; transition: all 0.3s; }
        .mixer-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #eee; cursor: pointer; user-select: none; }
        .mixer-header:hover { background-color: #f8f9ff; }
        .mixer-title { color: #3f51b5; font-weight: 800; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .toggle-icon { font-size: 12px; color: #aaa; transition: transform 0.3s; }
        .collapsed .toggle-icon { transform: rotate(-90deg); }
        .collapsed .content-wrap { display: none; }
        .collapsed .mixer-header, .collapsed .goal-header-bar { border-bottom: none; padding-bottom: 0; }

        .mixer-table { width: 100%; font-size: 12px; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        .mixer-table th { background: #f0f4f8; padding: 12px 8px; color: #5c6bc0; font-weight: 600; text-align: center; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        .mixer-table td { padding: 12px 8px; border-bottom: 1px solid #f0f0f0; text-align: center; vertical-align: middle; }
        .mix-inp { width: 80%; max-width: 100px; height: 32px; text-align: center; padding: 4px; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; background: #fff; font-size: 14px; color: #333; }
        .mix-inp:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(52,152,219,0.1); }
        .mix-res-val { font-family: monospace; }
        
        .gap-analysis-bar { display: grid; grid-template-columns: 1fr 1fr 0.5fr 1fr; gap: 10px; align-items: center; background: #fff; border: 2px dashed #b2dfdb; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .gap-box { text-align: center; }
        .gap-val { font-size: 22px; font-weight: 800; margin-top: 4px; }
        .gap-ratio-text { font-size: 14px; color: #888; font-weight: 600; }
        .pct-tag { font-size: 12px; color: #666; font-weight: normal; margin-left: 4px; }
        
        /* --- Goal Section (目标沙盘) --- */
        .goal-section { background: #fffbf0; border: 1px solid #ffe0b2; border-radius: var(--radius-md); padding: 15px; transition: all 0.3s; }
        .goal-header-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px dashed #ffe082; margin-bottom: 15px; cursor: pointer; user-select: none; }
        .goal-header-bar:hover { background-color: #fff8e1; }
        .goal-title { color: #f57f17; font-weight: 800; font-size: 16px; display: flex; align-items: center; gap: 8px; }

        /* 目标沙盘 9列并排样式 */
        .goal-breakdown-container {
            grid-column: 1 / -1; 
            display: grid;
            grid-template-columns: repeat(9, 1fr); 
            gap: 3px;
            margin-top: 10px;
            overflow-x: auto; 
        }

        .gb-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px 1px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            min-width: 0; 
        }

        .gb-title { font-size: 10.5px; color: #7f8c8d; margin-bottom: 5px; font-weight: 600; white-space: nowrap; letter-spacing: -0.8px; }
        .gb-val-usd { font-size: 15px; font-weight: 800; color: #2c3e50; font-family: monospace; margin-bottom: 2px; }
        .gb-sub-row { display: flex; flex-direction: column; gap: 1px; width: 100%; text-align: center;}
        .gb-val-rmb { font-size: 11px; color: #999; font-family: -apple-system; font-weight:normal; }
        .gb-pct { font-size: 10px; font-weight: bold; background: #f0f2f5; padding: 1px 4px; border-radius: 4px; display: inline-block; margin-top: 2px; width: fit-content; margin-left: auto; margin-right: auto;}

        .gb-card.type-sales { border-top: 3px solid #34495e; background: #fcfcfc; }
        .gb-card.type-cost { border-top: 3px solid #95a5a6; }     
        .gb-card.type-log { border-top: 3px solid #9b59b6; }      
        .gb-card.type-fba { border-top: 3px solid #7f8c8d; }      
        .gb-card.type-ret { border-top: 3px solid #e74c3c; }      
        .gb-card.type-comm { border-top: 3px solid #f39c12; }     
        .gb-card.type-ads { border-top: 3px solid #f1c40f; background: #fffdf0; }
        .gb-card.type-total-cost { border-top: 3px solid #546e7a; background: #fdfdfe; } 
        .gb-card.type-profit { border-top: 3px solid #27ae60; background: #f0f9eb; } 
        
        .gb-card.type-profit .gb-val-usd { color: #27ae60; }
        .gb-card.type-ads .gb-val-usd { color: #d35400; }
        .gb-card.type-total-cost .gb-val-usd { color: #546e7a; }
        
        .hidden-inputs { display: none; }
        .comm-box { background: #f9f9f9; padding: 8px; border-radius: 6px; margin-top: 5px; }
        .comm-toggle-label { display: flex; justify-content: space-between; cursor: pointer; font-size: 11px; font-weight: 600; color: #555;}
        .switch-ui { position: relative; width: 32px; height: 18px; background: #ccc; border-radius: 18px; transition: .3s; }
        .switch-ui::after { content: ''; position: absolute; left: 2px; top: 2px; width: 14px; height: 14px; background: #fff; border-radius: 50%; transition: .3s; }
        .native-checkbox:checked + .switch-ui { background: var(--accent); }
        .native-checkbox:checked + .switch-ui::after { transform: translateX(14px); }
        .comparison-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }

        /* --- Analysis Center --- */
        .analysis-container { display: none; margin-top: 20px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0; overflow:hidden; }
        .analysis-container.active { display: block; }
        
        .analysis-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .an-tab { padding: 10px 20px; cursor: pointer; font-size: 12px; font-weight: 600; color: #666; border-right: 1px solid #eee; transition: .2s; }
        .an-tab:hover { background: #fff; }
        .an-tab.active { background: #fff; color: #2980b9; border-bottom: 2px solid #2980b9; }
        
        .an-content { padding: 20px; min-height: 220px; }
        .an-pane { display: none; }
        .an-pane.active { display: block; }

        .chart-layout-grid { display: grid; grid-template-columns: 320px 1fr; gap: 30px; align-items: center; }
        .chart-wrapper { width: 100%; height: 200px; position: relative; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .metric-card { background: #f8f9fa; border-left: 4px solid #ccc; padding: 10px; border-radius: 4px; }
        
        .metric-title { font-size: 12px; color: #888; margin-bottom: 6px; font-weight: bold; display: flex; align-items: center; justify-content: flex-start; }
        .metric-formula { font-size: 10px; color: #b0bec5; font-weight: normal; margin-left: 8px; background: #fff; border: 1px solid #eee; padding: 1px 5px; border-radius: 4px; font-family: monospace; }
        .metric-value { font-size: 18px; font-weight: 800; color: #333; font-family: monospace; }

        /* --- Updated Mix Tab Styles --- */
        .mix-container { display: flex; flex-direction: column; gap: 20px; }
        .mix-controls-row { 
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; align-items: center; 
            background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 8px; 
        }
        .mix-input-group { display: flex; flex-direction: column; gap: 5px; }
        .mix-input-label { font-size: 11px; font-weight: bold; color: #555; }
        .mix-manual-input { 
            border: 1px solid #ccc; border-radius: 4px; padding: 6px; 
            font-size: 14px; font-weight: bold; color: #2c3e50; text-align: center; width: 80%;
        }
        .mix-metric-box { 
            text-align: center; border-left: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .mix-metric-val { font-size: 20px; font-weight: 800; color: #34495e; font-family: monospace; }
        .mix-metric-desc { font-size: 11px; color: #999; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        
        .mix-charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 320px; }
        .mix-chart-card { border: 1px solid #eee; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .mix-chart-title { font-size: 12px; font-weight: bold; color: #455a64; margin-bottom: 10px; text-align: center; }
        .mix-chart-body { flex: 1; position: relative; width: 100%; }

        .mix-warning { text-align: center; font-size: 12px; color: #e67e22; margin-top: 10px; font-weight: 600; }

        /* --- Snapshot Comparison Section --- */
        .snapshot-container { margin-top: 20px; border-top: 2px dashed #ffe082; padding-top: 15px; }
        .snapshot-title { font-size: 14px; font-weight: bold; color: #795548; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .snapshot-controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; background: #fffbf0; padding: 8px; border-radius: 6px; border: 1px solid #ffe0b2; }
        
        .snap-currency-group { display: flex; align-items: center; gap: 10px; }
        .snap-radio-label { font-size: 12px; color: #555; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .snap-radio-label input { cursor: pointer; }
        
        .col-toggle-bar { display: flex; flex-wrap:wrap; gap: 4px; align-items: center; }
        .toggle-btn { background: #fff; border: 1px solid #ffe0b2; border-radius: 4px; padding: 3px 8px; font-size: 11px; color: #8d6e63; cursor: pointer; transition: 0.2s; }
        .toggle-btn.active { background: #ffe0b2; color: #e65100; font-weight: bold; border-color: #ffcc80; }
        .toggle-btn:hover { background: #fff3e0; }

        .snapshot-table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-radius: 6px; overflow: hidden; }
        .snapshot-table th { background: #fff8e1; padding: 8px; color: #f57f17; font-weight: 600; text-align: center; border-bottom: 1px solid #ffe082; white-space: nowrap; }
        .snapshot-table td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; color: #555; vertical-align: middle; }
        .snapshot-table tr:hover { background: #fffde7; }
        
        .sku-input { width: 90%; max-width:120px; border: 1px solid #eee; border-radius: 4px; padding: 4px; font-size: 12px; color: #333; }
        .btn-action-group { display: flex; gap: 8px; }
        .btn-export { font-size: 12px; padding: 4px 12px; border-radius: 4px; border: none; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; transition: .2s;}
        .btn-excel { background: #27ae60; } 
        .btn-pdf { background: #e74c3c; } 
        .btn-del-snap { border: none; background: none; color: #aaa; cursor: pointer; font-size: 16px; font-weight: bold;}
        .btn-del-snap:hover { color: #e74c3c; }
        .col-hidden { display: none !important; }
        
        /* --- Sensitivity Matrix --- */
        .sensitivity-section { grid-column: 1 / -1; background: #fff; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); margin-top: 25px; border-left: 5px solid #2c3e50; }
        .sens-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .sens-title { font-size: 16px; font-weight: 800; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        
        .sens-controls { background: #eceff1; padding: 10px; border-radius: 8px; margin-bottom: 15px; display:flex; gap: 20px; align-items:center; flex-wrap: wrap;}
        .sens-control-group { display: flex; align-items: center; gap: 8px; }
        .sens-label { font-size: 12px; font-weight: bold; color: #546e7a; }
        .sens-slider { width: 120px; cursor: pointer; }
        .sens-val-disp { font-family: monospace; font-weight: bold; color: #37474f; background: #fff; padding: 2px 6px; border-radius: 4px; min-width: 40px; text-align: center; }
        .sens-reset-btn { font-size: 11px; color: #0277bd; cursor: pointer; text-decoration: underline; background: none; border: none; }

        .sens-table-wrapper { overflow-x: auto; display: flex; justify-content: center; }
        .sens-table { border-collapse: collapse; font-size: 12px; font-family: monospace; }
        .sens-table th, .sens-table td { border: 2px solid #fff; padding: 12px 14px; text-align: center; min-width: 75px; }
        .sens-table th { background: #cfd8dc; color: #455a64; font-weight: bold; }
        .sens-corner { background: #fff !important; border: none !important; }
        .sens-label-x { text-align: center; margin-top: 5px; font-weight: bold; color: #78909c; font-size: 12px; }
        .sens-label-y { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-weight: bold; color: #78909c; font-size: 12px; margin-right: 10px; }

        .sens-legend { display: flex; gap: 2px; align-items: center; font-size: 10px; color: #666; margin-top: 10px; justify-content: center; }
        .sens-legend-box { width: 12px; height: 12px; margin-left: 8px; margin-right: 2px; border: 1px solid #ddd; }

        /* --- Promo Analysis Tab Styles (New) --- */
        .promo-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .promo-left { display: flex; flex-direction: column; gap: 15px; }
        .promo-right { display: flex; flex-direction: column; gap: 15px; }
        
        .promo-input-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fff; }
        .promo-input-row { margin-bottom: 12px; }
        .promo-input-row label { display: block; font-size: 12px; color: #555; font-weight: bold; margin-bottom: 4px; }
        .promo-input { width: 100%; padding: 8px; border: 1px solid #ffe0b2; background: #fffbf0; border-radius: 4px; font-weight: bold; font-size: 14px; text-align: right; box-sizing: border-box; }
        
        .promo-detail-table { width: 100%; font-size: 12px; margin-top: 10px; }
        .promo-detail-table td { padding: 4px 0; border-bottom: 1px dashed #eee; }
        .promo-detail-table .val { text-align: right; font-weight: 500; }
        
        .promo-result-box { padding: 10px; border-radius: 6px; margin-top: 10px; text-align: center; border: 1px solid transparent; }
        .promo-result-box.green { background: #e8f5e9; border-color: #c8e6c9; }
        .promo-result-box.red { background: #ffebee; border-color: #ffcdd2; }
        .promo-res-label { font-size: 12px; font-weight: bold; }
        .promo-result-box.green .promo-res-label { color: #2e7d32; }
        .promo-result-box.red .promo-res-label { color: #c62828; }
        .promo-res-val { font-size: 20px; font-weight: 800; margin-top: 5px; font-family: monospace; }
        .promo-result-box.green .promo-res-val { color: #2e7d32; }
        .promo-result-box.red .promo-res-val { color: #d32f2f; }
        
        .month-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .month-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; background: #fff; display: flex; flex-direction: column; align-items: center; }
        .month-title { font-size: 13px; font-weight: bold; color: #37474f; border-bottom: 2px solid #37474f; padding-bottom: 4px; margin-bottom: 10px; width: 100%; text-align: center; }
        .month-input { width: 100%; padding: 8px; border: 1px solid #ffe0b2; background: #fffbf0; border-radius: 4px; font-weight: bold; font-size: 16px; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        .month-stat { text-align: center; margin-top: 8px; width: 100%; }
        .month-stat-label { font-size: 11px; color: #999; }
        .month-stat-val { font-size: 16px; font-weight: 800; color: #455a64; font-family: monospace; }
        
        /* Summary Bar Grid Layout */
        .summary-bar { background: #37474f; color: white; padding: 15px 20px; border-radius: 8px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; font-size: 13px; margin-top: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sum-item { display: flex; flex-direction: column; align-items: center; border-right: 1px solid #546e7a; padding: 0 10px; }
        .sum-item:last-child { border-right: none; }
        .sum-label { font-size: 11px; color: #b0bec5; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; }
        .sum-val { font-weight: 800; font-size: 18px; font-family: monospace; }
        .sum-neg { color: #ffccbc; } .sum-pos { color: #a5d6a7; }
        .sum-warn { color: #ffcc80; }
        
        /* Bottom Split Layout */
        .promo-bottom-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        
        .recovery-box { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; box-sizing: border-box; }
        .rec-title { font-size: 14px; font-weight: bold; color: #2e7d32; display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
        .rec-days { font-size: 36px; font-weight: 800; color: #2e7d32; line-height: 1; margin: 10px 0; }
        .rec-desc { font-size: 12px; color: #555; }
        
        .supply-box { background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; }
        .supply-title { font-size: 14px; font-weight: bold; color: #1565c0; display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .supply-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #455a64; }
        .supply-val { font-weight: 800; color: #0d47a1; }
        .supply-input { width: 60px; text-align: center; padding: 2px 5px; border: 1px solid #90caf9; border-radius: 4px; font-weight: bold; color: #0d47a1; }
        .supply-total-box { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #90caf9; display: flex; justify-content: space-between; align-items: center; }
        .supply-big-val { font-size: 18px; font-weight: 800; color: #1565c0; font-family: monospace; }

        .cpa-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #e0e0e0; }
        .cpa-val { font-weight: 800; color: #e65100; }

        @media (max-width: 1200px) {
            .main-container { grid-template-columns: 1fr; }
            .left-sidebar { display: grid; grid-template-columns: 1fr 1fr; }
            .top-metrics-grid { grid-template-columns: 1fr; }
            .goal-breakdown-container { grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .sens-controls { flex-direction: column; align-items: flex-start; }
            .chart-layout-grid { grid-template-columns: 1fr; }
            .mix-controls-row { grid-template-columns: repeat(2, 1fr); }
            .mix-charts-row { grid-template-columns: 1fr; height: auto; }
            .mix-chart-card { height: 250px; }
            .promo-layout { grid-template-columns: 1fr; }
            .month-grid { grid-template-columns: 1fr; }
            .summary-bar { grid-template-columns: 1fr 1fr; gap: 20px; }
            .sum-item { border-right: none; }
            .promo-bottom-split { grid-template-columns: 1fr; }
        }
        
        @media print {
            .manager-bar, .left-sidebar, .top-metrics-grid, .mixer-section, .goal-section > .content-wrap > div:not(#goal_snapshot_area), .comparison-section, .goal-header-bar, .hidden-inputs, .sensitivity-section {
                display: none !important;
            }
            .goal-section { border: none; padding: 0; background: #fff; }
            .main-container { display: block; }
            .right-content { display: block; }
            .snapshot-container { border: none; margin: 0; padding: 0; }
            .snapshot-table { box-shadow: none; border: 1px solid #ccc; width: 100%; }
            .btn-del-snap, .col-toggle-bar, .snapshot-controls-row { display: none; } 
        }
    </style>
</head>
<body>

<div class="main-container">
    
    <div class="manager-bar">
        <div class="manager-left">
            <span style="font-weight:bold; color:var(--primary);">📦 产品档案:</span>
            <input type="text" id="product_name" class="prod-name-input" placeholder="输入产品名称..." list="history_list">
            <datalist id="history_list"></datalist>
            <button class="btn btn-save" onclick="saveProduct()">💾 保存</button>
            <button class="btn btn-new" onclick="smartClear()">🔄 重置</button>
        </div>
        <div class="manager-right">
            <span id="autosave_status" style="font-size:11px; color:#aaa; font-family:monospace;">--</span>
            <button class="btn btn-io" onclick="exportData()">备份</button>
            <button class="btn btn-io" onclick="$('file_import').click()">恢复</button>
            <input type="file" id="file_import" style="display:none" onchange="importData(this)">
        </div>
    </div>

    <div class="left-sidebar">
        <div class="card" style="border-left: 4px solid var(--warning);">
            <h2>运营目标</h2>
            <div class="input-group">
                <label class="input-label">TACOS / 利润率</label>
                <div style="display:flex; gap:8px;">
                    <div class="input-wrapper" style="flex:1">
                        <input type="number" id="inp_acos" class="input-field" value="15" step="1" min="0" onchange="if(this.value<0)this.value=0">
                        <span class="input-unit">%</span>
                    </div>
                    <div class="input-wrapper" style="flex:1">
                        <input type="number" id="inp_margin" class="input-field" value="15" step="1">
                        <span class="input-unit">%</span>
                    </div>
                </div>
            </div>
            <div class="comm-box">
                <label class="comm-toggle-label">
                    <span>自动服装佣金 (阶梯)</span>
                    <input type="checkbox" id="chk_auto_comm" class="native-checkbox" checked style="display:none;">
                    <span class="switch-ui"></span>
                </label>
                <div class="input-wrapper" style="margin-top:5px;">
                    <input type="number" id="inp_manual_comm" class="input-field" value="17" readonly step="1" min="0" onchange="if(this.value<0)this.value=0">
                    <span class="input-unit">%</span>
                </div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid var(--accent);">
            <h2>产品成本</h2>
            <div class="input-group">
                <label class="input-label">采购价</label>
                <div class="input-wrapper">
                    <input type="number" id="inp_purchase" class="input-field" value="19.99" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                    <span class="input-unit">¥</span>
                </div>
                <div class="usd-preview" id="disp_usd_cost">$2.82</div>
            </div>
            <div class="input-group">
                <label class="input-label">汇率</label>
                <div class="input-wrapper">
                    <input type="number" id="inp_rate" class="input-field" value="7.1" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                </div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid var(--primary);">
            <h2>物流配送</h2>
            <div class="input-group">
                <label class="input-label">头程运费</label>
                <div class="input-wrapper">
                    <input type="number" id="inp_freight" class="input-field" value="0.9" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                    <span class="input-unit">$</span>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">FBA 配送费</label>
                <div class="input-wrapper">
                    <input type="number" id="inp_fba" class="input-field" value="5.69" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                    <span class="input-unit">$</span>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">杂费/入库</label>
                <div class="input-wrapper">
                    <input type="number" id="inp_other" class="input-field" value="0" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                    <span class="input-unit">$</span>
                </div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid var(--danger);">
            <h2>退货模型</h2>
            <div class="input-group">
                <label class="input-label">退货率 / 不可售</label>
                <div style="display:flex; gap:8px;">
                    <div class="input-wrapper" style="flex:1">
                        <input type="number" id="inp_ret_rate" class="input-field" value="10" step="1" min="0" onchange="if(this.value<0)this.value=0">
                        <span class="input-unit">%</span>
                    </div>
                    <div class="input-wrapper" style="flex:1">
                        <input type="number" id="inp_unsell" class="input-field" value="20" step="1" min="0" onchange="if(this.value<0)this.value=0">
                        <span class="input-unit">%</span>
                    </div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:10px;">
                <div>
                    <label class="input-label">处理费</label>
                    <div class="input-wrapper">
                        <input type="number" id="inp_ret_proc" class="input-field input-field-compact" value="2.62" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                        <span class="input-unit">$</span>
                    </div>
                </div>
                <div>
                    <label class="input-label">管理费</label>
                    <div class="input-wrapper">
                        <input type="number" id="disp_ret_admin" class="input-field input-field-compact" value="0.34" readonly style="background:#f5f5f5; color:#999;">
                        <span class="input-unit">$</span>
                    </div>
                </div>
                <div>
                    <label class="input-label">移除费</label>
                    <div class="input-wrapper">
                        <input type="number" id="inp_ret_rem" class="input-field input-field-compact" value="2.24" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                        <span class="input-unit">$</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-content">
        <div class="top-metrics-grid">
            <div class="card" style="border-top: 4px solid var(--accent);">
                <div class="result-card-header">
                    <span style="font-size:10px; background:#e3f2fd; color:#1565c0; padding:2px 8px; border-radius:10px;">PLAN A: 建议目标价</span>
                    <div class="price-display" id="res_target_price">$15.98</div>
                    <div class="margin-display">基于 <span class="margin-val" id="txt_target_margin">15.0%</span> 目标利润率</div>
                </div>
                <table class="pnl-table">
                    <tbody id="table_target"></tbody>
                </table>
                <div class="footer-highlight">
                    <div class="fh-item"><span class="fh-label">盈亏平衡</span><span id="be_target" class="fh-val">--</span></div>
                    <div class="fh-item"><span class="fh-label">售卖成本</span><span id="cost_target" class="fh-val" style="color:#d35400;">--</span></div>
                    <div class="fh-item"><span class="fh-label">单品净利</span><span id="profit_target_display" class="fh-val" style="color:var(--success);">--</span></div>
                    <div class="fh-item"><span class="fh-label">佣金比</span><span id="comm_target" class="fh-val">--</span></div>
                </div>
            </div>

            <div class="card" style="border-top: 4px solid var(--primary);">
                <div class="result-card-header">
                    <span style="font-size:10px; background:#34495e; color:#fff; padding:2px 8px; border-radius:10px;">PLAN B: 实际定价</span>
                    <input type="number" id="inp_actual_price" class="actual-input" value="16.99" step="0.01" min="0" onchange="if(this.value<0)this.value=0">
                    <div class="margin-display">实际净利润率: <span class="margin-val" id="txt_actual_margin">18.8%</span></div>
                </div>
                <table class="pnl-table">
                    <tbody id="table_actual"></tbody>
                </table>
                 <div class="footer-highlight">
                    <div class="fh-item"><span class="fh-label">盈亏平衡</span><span id="be_actual" class="fh-val">--</span></div>
                    <div class="fh-item"><span class="fh-label">售卖成本</span><span id="cost_actual" class="fh-val" style="color:#d35400;">--</span></div>
                    <div class="fh-item"><span class="fh-label">实际净利</span><span id="profit_actual_display" class="fh-val" style="color:var(--success);">--</span></div>
                    <div class="fh-item"><span class="fh-label">佣金比</span><span id="comm_actual" class="fh-val">--</span></div>
                </div>
            </div>

            <div class="card" style="border-top: 4px solid var(--purple); background:#fcf8fd;">
                <div class="result-card-header" style="border-bottom-color:#e1bee7;">
                    <span style="font-size:14px; font-weight:bold; color:#8e24aa; display:block; margin-bottom:2px;">广告投放模拟</span>
                    <div style="font-size:10px; color:#aaa;">(数据联动 Plan B)</div>
                </div>
                
                <div class="ad-input-grid">
                    <div class="ad-input-box"><label>总预算</label><input type="number" id="ads_budget" value="0.00" style="color:#333;" min="0" onchange="if(this.value<0)this.value=0"></div>
                    <div class="ad-input-box"><label>平均CPC</label><input type="number" id="ads_cpc" value="0.54" step="0.01" min="0" onchange="if(this.value<0)this.value=0"></div>
                    <div class="ad-input-box"><label>预估转化</label><input type="number" id="ads_cvr" value="11" min="0" onchange="if(this.value<0)this.value=0"></div>
                </div>

                <table class="ad-data-table">
                    <tr><td class="ad-row-title">客单价 (Price)</td><td class="ad-val ad-val-price" id="ad_unit_price" style="text-align:right;">$0.00</td></tr>
                    <tr><td class="ad-row-title">单品售卖成本 (含退货)</td><td class="ad-val ad-val-cost" id="ad_unit_cost" style="text-align:right;">$0.00</td></tr>
                    <tr><td class="ad-row-title">广告前单利 (Gross)</td><td class="ad-val ad-val-profit" id="ad_unit_profit" style="text-align:right;">$0.00</td></tr>
                    <tr><td colspan="2" style="height:4px;"></td></tr>
                    <tr><td style="color:#999;">点击次数 (Clicks)</td><td class="ad-val" id="ad_clicks" style="text-align:right;">0</td></tr>
                    <tr><td style="color:#999;">订单数 (Orders)</td><td class="ad-val" id="ad_orders" style="text-align:right;">0.0</td></tr>
                    <tr><td style="color:#999;">广告销售额</td><td class="ad-val" id="ad_total_sales" style="text-align:right;">$0.00</td></tr>
                    <tr><td style="color:#999;">广告总成本</td><td class="ad-val" id="ad_total_cost" style="text-align:right;">$0.00</td></tr>
                    <tr><td style="color:#e74c3c;">盈亏平衡 CPC</td><td class="ad-val" id="ad_be_cpc" style="text-align:right; color:#e74c3c;">$0.00</td></tr>
                    <tr><td style="color:#333;">预估 ACOS</td><td class="ad-val" id="ad_acos" style="text-align:right;">0.00%</td></tr>
                    <tr style="background:#e8f5e9;"><td style="color:#27ae60; font-weight:bold;">预估日净利润</td><td class="ad-val" id="ad_net_profit" style="text-align:right; color:#27ae60;">$0.00</td></tr>
                </table>
            </div>
        </div>

        <div class="mixer-section" id="mixer_module">
            <div class="mixer-header" onclick="toggleMixer()">
                <div class="mixer-title">
                    🌊 流量执行推演 (基于目标预算分配) <span class="toggle-icon">▼</span>
                </div>
                <div style="font-size:12px; display:flex; gap:15px; align-items:center;">
                    <span style="background:#e3f2fd; color:#1565c0; padding:2px 8px; border-radius:4px; font-size:11px;">
                        🔗 预算源: <span id="mix_source_label">月度目标</span>
                    </span>
                </div>
            </div>
            <div class="content-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; margin-top:5px; background:#f4f6f7; padding:8px; border-radius:6px;">
                    <div style="font-size:13px; color:#34495e;">
                        <strong>💰 可分配总预算:</strong> 
                        <span id="mix_total_budget" style="font-size:16px; font-weight:800; color:#f57f17; margin-left:5px;">$0.00</span>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table class="mixer-table">
                        <thead>
                            <tr><th>预估 CPC</th><th>预估 CTR %</th><th>预估 CVR %</th><th>点击</th><th>曝光量</th><th>广告单量</th><th>ACOS</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="number" id="mix_sp_cpc" class="mix-inp" value="0.65" step="0.01" min="0"></td>
                                <td><input type="number" id="mix_sp_ctr" class="mix-inp" value="0.5" step="0.1" min="0"></td>
                                <td><input type="number" id="mix_sp_cvr" class="mix-inp" value="11" min="0"></td>
                                <td style="font-weight:bold; color:#2980b9;" id="mix_sp_clicks">0</td>
                                <td style="color:#555; font-weight:bold;" id="mix_sp_imp">0</td>
                                <td style="font-weight:bold; font-size:14px; color:#e67e22; background:#fff3e0;" id="mix_sp_orders">0</td>
                                <td><div id="mix_sp_acos" style="font-weight:bold;">0.0%</div><span id="mix_sp_status" style="font-size:10px;"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="gap-analysis-bar">
                    <div class="gap-box" style="border-right:1px dashed #ccc;">
                        <span style="display:block; font-size:11px; color:#7f8c8d; margin-bottom:5px;">🎯 总目标单量 (Goal)</span>
                        <div class="gap-val" id="mix_goal_units_display" style="font-size:24px; color:#34495e;">0</div>
                    </div>
                    <div class="gap-box" style="border-right:1px dashed #ccc;">
                        <span style="display:block; font-size:11px; color:#d35400; margin-bottom:5px;">📢 预算能买到的广告单</span>
                        <div class="gap-val" style="color:#e67e22;"><span id="mix_total_ad_orders">0</span></div>
                    </div>
                    <div class="gap-box" style="border-right:1px dashed #ccc;">
                        <span style="display:block; font-size:11px; color:#999; margin-bottom:5px;">⚖️ 广告:自然</span>
                        <div class="gap-ratio-text" id="mix_ratio_display" style="font-size:18px; color:#555;">1 : -</div>
                    </div>
                    <div class="gap-box">
                        <span style="display:block; font-size:11px; color:#27ae60; margin-bottom:5px;">🌱 需补足的自然单 (Gap)</span>
                        <div class="gap-val" style="color:#27ae60;"><span id="mix_org_needed">0</span></div>
                    </div>
                </div>
                <div id="mix_feasibility_msg" style="text-align:center; font-size:12px; margin-top:10px; color:#aaa;"></div>
                <div style="display:none;"><input type="number" id="guard_acos" value="80"><input type="number" id="guard_cpc" value="2.5"></div>
            </div>
        </div>

        <div class="goal-section" id="goal_module">
            <div class="goal-header-bar" onclick="toggleGoal()">
                <div class="goal-title">
                    🎯 销售目标沙盘 <span class="toggle-icon">▼</span>
                    <span style="font-size:12px; font-weight:normal; color:#d68910; margin-left:10px;">(月度目标 / 目标均价)</span>
                </div>
                <span id="goal_current_price" style="background:#fff; padding:2px 8px; border-radius:4px; font-size:14px;">$16.99</span>
            </div>
            <div class="content-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#fff8e1; padding:10px; border-radius:8px;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                             <span style="font-weight:bold; color:#f57f17; font-size:14px;">📦 目标销量:</span>
                             <div class="input-wrapper" style="width:100px;">
                                 <input type="number" id="goal_units" class="input-field" value="0" style="font-size:16px; height:36px; color:#d35400; border:2px solid #ffe082;" min="0" onchange="if(this.value<0)this.value=0">
                             </div>
                        </div>
                    </div>
                    <div>
                         <button onclick="captureGoalSnapshot()" style="background:#8e44ad; color:white; border:none; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:10px;">📸 加入对比</button>
                         <button id="btn_toggle_chart" onclick="toggleChart()" style="background:#2c3e50; color:white; border:none; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:10px;">📊 分析中心</button>
                         <button id="btn_month" onclick="setTimeMode('month')" style="background:#f57f17; color:white; border:none; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">月度视图</button>
                         <button id="btn_day" onclick="setTimeMode('day')" style="background:transparent; color:#f57f17; border:1px solid #f57f17; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">日均视图</button>
                    </div>
                </div>
                
                <div id="chart_panel" class="analysis-container">
                    <div class="analysis-tabs">
                        <div class="an-tab active" onclick="switchTab('pie')">📊 成本分布 (饼图)</div>
                        <div class="an-tab" onclick="switchTab('waterfall')">🌊 利润瀑布 (Waterfall)</div>
                        <div class="an-tab" onclick="switchTab('mix')">⚖️ 战略博弈 (Volume vs Profit)</div>
                        <div class="an-tab" onclick="switchTab('promo')">🚀 推广推演 (Promotion Analysis)</div>
                    </div>
                    
                    <div class="an-content">
                        <div id="tab_pie" class="an-pane active">
                            <div class="chart-layout-grid">
                                <div class="chart-wrapper"><canvas id="goalPieChart"></canvas></div>
                                <div class="metrics-grid">
                                    <div class="metric-card" style="border-left-color: #27ae60;">
                                        <div class="metric-title">ROI <span class="metric-formula">净利 ÷ 总成本</span></div>
                                        <div class="metric-value" id="val_roi" style="color:#27ae60;">0%</div>
                                    </div>
                                    <div class="metric-card" style="border-left-color: #f39c12;">
                                        <div class="metric-title">ROAS <span class="metric-formula">销售额 ÷ 广告费</span></div>
                                        <div class="metric-value" id="val_roas" style="color:#f39c12;">0.00</div>
                                    </div>
                                    <div class="metric-card" style="border-left-color: #34495e;">
                                        <div class="metric-title">资金利用率 <span class="metric-formula">销售额 ÷ 采购成本</span></div>
                                        <div class="metric-value" id="val_capital_efficiency">0%</div>
                                    </div>
                                    <div class="metric-card" style="border-left-color: #e74c3c;">
                                        <div class="metric-title">盈亏平衡 ROAS <span class="metric-formula">销售额 ÷ 广告前毛利</span></div>
                                        <div class="metric-value" id="val_be_roas" style="color:#e74c3c;">0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab_waterfall" class="an-pane">
                            <div style="height:250px;"><canvas id="waterfallChart"></canvas></div>
                            <div style="text-align:center; color:#999; font-size:12px; margin-top:5px;">* 直观展示销售额被各项成本削减的过程</div>
                        </div>
                        
                        <div id="tab_mix" class="an-pane">
                            <div class="mix-container">
                                <div class="mix-controls-row">
                                    <div class="mix-input-group">
                                        <span class="mix-input-label">模拟 CPC</span>
                                        <input type="number" id="sim_cpc" class="mix-manual-input" value="0.90" step="0.01">
                                    </div>
                                    <div class="mix-input-group">
                                        <span class="mix-input-label">模拟 CVR (%)</span>
                                        <input type="number" id="sim_cvr" class="mix-manual-input" value="11" step="0.1">
                                    </div>
                                    <div class="mix-metric-box">
                                        <div class="mix-metric-val" id="mix_disp_budget">$0.00</div>
                                        <div class="mix-metric-desc">🔒 锁定总预算</div>
                                    </div>
                                    <div class="mix-metric-box">
                                        <div class="mix-metric-val" style="color:#e67e22;" id="mix_disp_ad_orders">0</div>
                                        <div class="mix-metric-desc">📉 广告单量</div>
                                    </div>
                                    <div class="mix-metric-box">
                                        <div class="mix-metric-val" style="color:#27ae60;" id="mix_disp_org_orders">0</div>
                                        <div class="mix-metric-desc">🌱 自然单量</div>
                                    </div>
                                    <div class="mix-metric-box" style="border:none;">
                                        <div class="mix-metric-val" style="color:#8e44ad;" id="mix_disp_bep_orders">0</div>
                                        <div class="mix-metric-desc">⚖️ 盈亏平衡单量</div>
                                    </div>
                                </div>
                                
                                <div class="mix-charts-row">
                                    <div class="mix-chart-card">
                                        <div class="mix-chart-title">📈 资金池消耗模拟</div>
                                        <div class="mix-chart-body"><canvas id="cashFlowChart"></canvas></div>
                                    </div>
                                    <div class="mix-chart-card">
                                        <div class="mix-chart-title">⚔️ 销量 vs 利润 (找准甜蜜点)</div>
                                        <div class="mix-chart-body"><canvas id="mixerChart"></canvas></div>
                                    </div>
                                </div>
                                <div class="mix-warning" id="mix_warning_text"></div>
                            </div>
                        </div>

                        <!-- Promotion Analysis Tab Content -->
                        <div id="tab_promo" class="an-pane">
                            <div class="promo-layout">
                                <div class="promo-left">
                                    <h4 style="color:#d35400; margin:0 0 10px 0;">🔥 单品模型设置 (Unit Economics)</h4>
                                    <div class="promo-input-card">
                                        <div class="promo-input-row">
                                            <label>推广期售价 ($)</label>
                                            <input type="number" id="promo_price" class="promo-input" value="14.99" step="0.01">
                                        </div>
                                        <div class="promo-input-row">
                                            <label>预估转化率 (%)</label>
                                            <input type="number" id="promo_cvr" class="promo-input" value="10" step="0.1">
                                        </div>
                                        <div class="promo-input-row">
                                            <label>预估 CPC ($)</label>
                                            <input type="number" id="promo_cpc" class="promo-input" value="1.5" step="0.01">
                                        </div>
                                    </div>

                                    <div class="promo-input-card" style="background:#fdfdfd;">
                                        <div style="font-size:12px; font-weight:bold; color:#333; display:flex; justify-content:space-between;">
                                            <span>单品账单明细</span>
                                            <span style="font-weight:normal; color:#999;">(保留2位小数)</span>
                                        </div>
                                        <table class="promo-detail-table">
                                            <tr><td>售价 Revenue</td><td class="val" id="pd_price">$14.99</td></tr>
                                            <tr><td>- 采购成本</td><td class="val" id="pd_prod">$2.82</td></tr>
                                            <tr><td>- 物流/杂费</td><td class="val" id="pd_log">$0.90</td></tr>
                                            <tr><td>- FBA配送</td><td class="val" id="pd_fba">$5.90</td></tr>
                                            <tr><td>- 平台佣金</td><td class="val" id="pd_comm">$0.75</td></tr>
                                            <tr><td>- 退货均摊</td><td class="val" id="pd_ret">$1.48</td></tr>
                                        </table>
                                        <div class="cpa-row">
                                            <span style="font-size:12px; font-weight:bold; color:#e65100;">- 获客成本 (CPA)</span>
                                            <span class="cpa-val" id="pd_cpa">$15.00</span>
                                        </div>
                                        <div style="text-align:right; font-size:10px; color:#aaa; margin-bottom:5px;">公式: CPC / 转化率</div>
                                        
                                        <div class="promo-result-box green">
                                            <div class="promo-res-label">= 单品毛利 (自然单)</div>
                                            <div class="promo-res-val" id="pd_gross_profit">$3.14</div>
                                        </div>
                                        <div class="promo-result-box red">
                                            <div class="promo-res-label">= 单品净盈亏 (100%广告单)</div>
                                            <div class="promo-res-val" id="pd_net_profit">$-6.86</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="promo-right">
                                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                                        <h4 style="color:#d35400; margin:0;">📅 季度推广推演 (Quarterly Strategy)</h4>
                                        <span style="font-size:11px; color:#999;">动态调整流量结构</span>
                                    </div>

                                    <div class="month-grid">
                                        <!-- Month 1 -->
                                        <div class="month-card">
                                            <div class="month-title">第 1 个月 (Day 1-30)</div>
                                            <label style="font-size:10px; color:#7f8c8d; margin-bottom:2px;">预估日销量 (Units)</label>
                                            <input type="number" id="p_m1_units" class="month-input" value="10">
                                            <label style="font-size:10px; color:#7f8c8d; margin-bottom:2px;">广告单占比 (%)</label>
                                            <input type="number" id="p_m1_ad_share" class="month-input" value="80" min="0" max="100">
                                            
                                            <div class="month-stat">
                                                <div class="month-stat-label">月广告费</div>
                                                <div class="month-stat-val" id="p_m1_spend">$0.00</div>
                                                <div style="font-size:10px; color:#999;" id="p_m1_acos">TACoS: 0.0%</div>
                                            </div>
                                            <div class="promo-result-box red" style="width:100%; box-sizing:border-box; margin-top:8px; padding:5px;">
                                                <div class="promo-res-label" style="font-size:11px;">月净盈亏 (Net)</div>
                                                <div class="promo-res-val" id="p_m1_profit" style="font-size:16px;">$0.00</div>
                                                <div style="font-size:9px; color:#999;">(总毛利 - 广告费)</div>
                                            </div>
                                        </div>
                                        <!-- Month 2 -->
                                        <div class="month-card">
                                            <div class="month-title">第 2 个月 (Day 31-60)</div>
                                            <label style="font-size:10px; color:#7f8c8d; margin-bottom:2px;">预估日销量 (Units)</label>
                                            <input type="number" id="p_m2_units" class="month-input" value="20">
                                            <label style="font-size:10px; color:#7f8c8d; margin-bottom:2px;">广告单占比 (%)</label>
                                            <input type="number" id="p_m2_ad_share" class="month-input" value="60" min="0" max="100">
                                            
                                            <div class="month-stat">
                                                <div class="month-stat-label">月广告费</div>
                                                <div class="month-stat-val" id="p_m2_spend">$0.00</div>
                                                <div style="font-size:10px; color:#999;" id="p_m2_acos">TACoS: 0.0%</div>
                                            </div>
                                            <div class="promo-result-box red" style="width:100%; box-sizing:border-box; margin-top:8px; padding:5px;">
                                                <div class="promo-res-label" style="font-size:11px;">月净盈亏 (Net)</div>
                                                <div class="promo-res-val" id="p_m2_profit" style="font-size:16px;">$0.00</div>
                                                <div style="font-size:9px; color:#999;">(总毛利 - 广告费)</div>
                                            </div>
                                        </div>
                                        <!-- Month 3 -->
                                        <div class="month-card">
                                            <div class="month-title">第 3 个月 (Day 61-90)</div>
                                            <label style="font-size:10px; color:#7f8c8d; margin-bottom:2px;">预估日销量 (Units)</label>
                                            <input type="number" id="p_m3_units" class="month-input" value="30">
                                            <label style="font-size:10px; color:#7f8c8d; margin-bottom:2px;">广告单占比 (%)</label>
                                            <input type="number" id="p_m3_ad_share" class="month-input" value="50" min="0" max="100">
                                            
                                            <div class="month-stat">
                                                <div class="month-stat-label">月广告费</div>
                                                <div class="month-stat-val" id="p_m3_spend">$0.00</div>
                                                <div style="font-size:10px; color:#999;" id="p_m3_acos">TACoS: 0.0%</div>
                                            </div>
                                            <div class="promo-result-box red" style="width:100%; box-sizing:border-box; margin-top:8px; padding:5px;">
                                                <div class="promo-res-label" style="font-size:11px;">月净盈亏 (Net)</div>
                                                <div class="promo-res-val" id="p_m3_profit" style="font-size:16px;">$0.00</div>
                                                <div style="font-size:9px; color:#999;">(总毛利 - 广告费)</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="summary-bar">
                                        <div class="sum-item">
                                            <div class="sum-label">总销售额 (REVENUE)</div>
                                            <div class="sum-val" id="p_total_revenue">$0.00</div>
                                        </div>
                                        <div class="sum-item">
                                            <div class="sum-label">总销量 (UNITS)</div>
                                            <div class="sum-val" id="p_total_units">0</div>
                                        </div>
                                        <div class="sum-item">
                                            <div class="sum-label">商品总成本 (COGS)</div>
                                            <div class="sum-val" id="p_total_cogs">$0.00</div>
                                        </div>
                                        <div class="sum-item">
                                            <div class="sum-label">总广告投入 (ADS)</div>
                                            <div class="sum-val sum-warn" id="p_total_spend">$0.00</div>
                                        </div>
                                        <div class="sum-item">
                                            <div class="sum-label">90天总盈亏 (NET)</div>
                                            <div class="sum-val sum-neg" id="p_total_profit">$0.00</div>
                                        </div>
                                    </div>

                                    <div class="promo-bottom-split">
                                        <div class="recovery-box">
                                            <div class="rec-title">⏳ 填坑回本计算</div>
                                            <div class="rec-desc">假设推广期结束后恢复 Plan B 正价与利润水平，需要卖多少单正价产品才能赚回上述总亏损?</div>
                                            <div class="rec-days"><span id="rec_units">0</span> <span style="font-size:20px; color:#2e7d32;">单</span></div>
                                            <div class="rec-desc" style="margin-top:5px;">需售出正价单量</div>
                                            <div style="margin-top:15px; border-top:1px dashed #c8e6c9; padding-top:10px; width:100%;">
                                                <div class="rec-desc">预计回本周期 (基于第3个月日销量):</div>
                                                <div style="font-size:24px; font-weight:800; color:#2e7d32; margin-top:5px;"><span id="rec_days">0</span> 天</div>
                                                <div style="font-size:11px; color:#555;" id="rec_months">(约 0 个月)</div>
                                            </div>
                                        </div>

                                        <div class="supply-box">
                                            <div class="supply-title">📦 供应链与资金压力</div>
                                            
                                            <div class="supply-row">
                                                <span>备货/海运周期 (Lead Time)</span>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="number" id="supply_lead_time" class="supply-input" value="45"> 天
                                                </div>
                                            </div>
                                            
                                            <div class="supply-row">
                                                <span>推广期备货 (M1-M3)</span>
                                                <span class="supply-val" id="sup_promo_stock">0</span>
                                            </div>
                                            <div class="supply-row">
                                                <span>安全/管道库存 (基于M3)</span>
                                                <span class="supply-val" id="sup_safe_stock">0</span>
                                            </div>
                                            <div class="supply-row" style="font-weight:bold;">
                                                <span>= 首批建议发货总量</span>
                                                <span class="supply-val" style="font-size:14px;" id="sup_total_stock">0</span>
                                            </div>
                                            
                                            <div class="supply-total-box">
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <span style="font-size:16px;">💰 累计最大资金需求</span>
                                                </div>
                                                <div style="text-align:right;">
                                                    <div class="supply-big-val" id="sup_total_capital">$0.00</div>
                                                    <div style="font-size:10px; color:#546e7a;">(库存成本 + 推广亏损)</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="goal-breakdown-container">
                    <div class="gb-card type-sales"><div class="gb-title">① 总销售额</div><div class="gb-val-usd" id="gb_sales">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_sales_rmb">¥0.00</span></div></div>
                    <div class="gb-card type-cost"><div class="gb-title">② 采购成本</div><div class="gb-val-usd" id="gb_prod">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_prod_rmb">¥0.00</span><span class="gb-pct" id="gb_prod_pct">0%</span></div></div>
                    <div class="gb-card type-log"><div class="gb-title">③ 物流/杂费</div><div class="gb-val-usd" id="gb_log">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_log_rmb">¥0.00</span><span class="gb-pct" id="gb_log_pct">0%</span></div></div>
                    <div class="gb-card type-fba"><div class="gb-title">④ FBA配送</div><div class="gb-val-usd" id="gb_fba">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_fba_rmb">¥0.00</span><span class="gb-pct" id="gb_fba_pct">0%</span></div></div>
                    <div class="gb-card type-ret"><div class="gb-title">⑤ 退货损耗</div><div class="gb-val-usd" id="gb_ret">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_ret_rmb">¥0.00</span><span class="gb-pct" id="gb_ret_pct">0%</span></div></div>
                    <div class="gb-card type-comm"><div class="gb-title">⑥ 平台佣金</div><div class="gb-val-usd" id="gb_comm">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_comm_rmb">¥0.00</span><span class="gb-pct" id="gb_comm_pct">0%</span></div></div>
                    <div class="gb-card type-ads"><div class="gb-title">⑦ 广告花费</div><div class="gb-val-usd" id="gb_ads">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_ads_rmb">¥0.00</span><span class="gb-pct" id="gb_ads_pct">0%</span></div></div>
                    <div class="gb-card type-total-cost"><div class="gb-title">⑧ 总投入成本</div><div class="gb-val-usd" id="gb_total_cost">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_total_cost_rmb">¥0.00</span><span class="gb-pct" id="gb_total_cost_pct">0%</span></div></div>
                    <div class="gb-card type-profit"><div class="gb-title">⑨ 净利润</div><div class="gb-val-usd" id="gb_profit">$0.00</div><div class="gb-sub-row"><span class="gb-val-rmb" id="gb_profit_rmb">¥0.00</span><span class="gb-pct" id="gb_profit_pct">0%</span></div></div>
                </div>
                <div id="goal_snapshot_area" class="snapshot-container" style="display:none;">
                    <div class="snapshot-title">
                        <span>📝 方案对比记录</span>
                        <div class="btn-action-group">
                             <button class="btn-export btn-excel" onclick="exportSnapshotsToExcel()">📥 导出 Excel</button>
                             <button class="btn-export btn-pdf" onclick="window.print()">🖨️ 打印/PDF</button>
                             <button onclick="clearGoalSnapshots()" class="btn-del-snap" style="font-size:12px; font-weight:normal; text-decoration:underline;">清空</button>
                        </div>
                    </div>
                    
                    <div class="snapshot-controls-row">
                        <div class="snap-currency-group">
                            <label class="snap-radio-label"><input type="radio" name="snap_currency" value="usd" checked onclick="renderGoalSnapshots()"> 美元 ($)</label>
                            <label class="snap-radio-label"><input type="radio" name="snap_currency" value="rmb" onclick="renderGoalSnapshots()"> 人民币 (¥)</label>
                        </div>
                        <div class="col-toggle-bar">
                            <span style="font-weight:bold; color:#f57f17; font-size:12px; margin-right:5px;">👁️ 列显示:</span>
                            <button class="toggle-btn" onclick="toggleSnapCol('sales')">销售额</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('prod')">采购</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('log')">物流</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('fba')">FBA</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('ret')">退货</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('comm')">佣金</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('ads')">广告</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('cost')">总成本</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('profit')">净利</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('margin')">利润率</button>
                            <button class="toggle-btn" onclick="toggleSnapCol('roi')">ROI</button>
                        </div>
                    </div>

                    <table class="snapshot-table" id="snap_table">
                        <thead>
                            <tr><th>方案名称 (SKU)</th><th>单量</th><th data-col="sales">销售额</th><th data-col="prod">采购成本</th><th data-col="log">物流/杂费</th><th data-col="fba">FBA配送</th><th data-col="ret">退货损耗</th><th data-col="comm">平台佣金</th><th data-col="ads">广告花费</th><th data-col="cost">总成本</th><th data-col="profit">净利润</th><th data-col="margin">利润率</th><th data-col="roi">ROI</th><th>操作</th></tr>
                        </thead>
                        <tbody id="goal_snapshot_tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="comparison-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h2 style="border:none; padding:0;">📊 全景对比表</h2>
                <button class="btn btn-excel" onclick="exportCSV()">导出 Excel</button>
            </div>
            <div style="overflow-x:auto; background:#fff; border-radius:8px; border:1px solid #eee;">
                <table class="comp-table" style="width:100%; border-collapse:collapse; font-size:12px;">
                    <thead>
                        <tr style="background:#f9f9f9; color:#666;">
                            <th style="padding:10px; text-align:left;">产品名称</th>
                            <th>采购价</th><th>建议价</th><th>实际价</th><th>单品净利</th><th>利润率</th><th>预算</th><th>CPC</th><th>ACOS</th><th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="comp_tbody"></tbody>
                </table>
            </div>
        </div>

        <div class="sensitivity-section" id="sensitivity_module">
            <div class="sens-header">
                <div class="sens-title">
                    🔍 三维动态沙盘 (单品净利 $)
                </div>
                <div style="font-size:12px; display:flex; gap:10px;">
                    <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <input type="radio" name="sens_mode" value="profit" checked onchange="triggerSensUpdate()"> 净利润 $ (默认)
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center; gap:5px; color:#999;">
                        <input type="radio" name="sens_mode" value="margin" onchange="triggerSensUpdate()"> 利润率 %
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center; gap:5px; color:#999;">
                        <input type="radio" name="sens_mode" value="roi" onchange="triggerSensUpdate()"> ROI %
                    </label>
                </div>
            </div>

            <div class="sens-controls">
                <div class="sens-control-group">
                    <span class="sens-label" style="color:#d35400;">🔥 流量/排名变量 (CVR):</span>
                    <button onclick="adjustSensCVR(-1)" style="cursor:pointer; border:1px solid #ccc; background:#fff; width:24px;">-</button>
                    <input type="range" id="sens_cvr_slider" class="sens-slider" min="1" max="50" value="10" oninput="syncSensCVR(this.value)">
                    <button onclick="adjustSensCVR(1)" style="cursor:pointer; border:1px solid #ccc; background:#fff; width:24px;">+</button>
                    <span id="sens_cvr_disp" class="sens-val-disp" style="border:1px solid #d35400; color:#d35400;">10%</span>
                    <button class="sens-reset-btn" onclick="resetSensCVR()">重置</button>
                </div>
                <div style="font-size:11px; color:#546e7a; border-left:1px solid #ccc; padding-left:15px; margin-left:5px;">
                    💡 拖动滑块模拟 CVR 变化，观察价格和 CPC 对<b>单品赚多少钱</b>的影响。
                </div>
            </div>

            <div style="display:flex; flex-direction:column; align-items:center;">
                <div class="sens-label-x">➡ 销售价格变化 ($)</div>
                <div style="display:flex; align-items:center;">
                    <div class="sens-label-y">➡ CPC 竞价变化 ($)</div>
                    <div class="sens-table-wrapper" id="matrix_container">
                        </div>
                </div>
            </div>

            <div class="sens-legend">
                <span class="sens-legend-box" style="background:#0277bd;"></span> > $2.00 / >30%
                <span class="sens-legend-box" style="background:#4fc3f7;"></span> 盈利 / 正ROI
                <span class="sens-legend-box" style="background:#e1f5fe;"></span> 保本
                <span class="sens-legend-box" style="background:#ffccbc;"></span> 微亏
                <span class="sens-legend-box" style="background:#d84315;"></span> 严重亏损
            </div>
        </div>

    </div>
</div>

<input type="hidden" id="raw_plan_b_profit" value="0">

<div class="hidden-inputs">
    <input type="number" id="goal_cpc" value="0.54">
    <input type="number" id="goal_cvr" value="11">
</div>

<script>
    const $ = id => document.getElementById(id);
    const parse = id => Math.max(0, parseFloat($(id).value) || 0);
    const round2 = num => Math.round((num + Number.EPSILON) * 100) / 100;
    const fmtUSD = num => '$' + num.toFixed(2);
    const fmtPct = num => (num * 100).toFixed(1) + '%';
    const fmtPct2 = num => (num * 100).toFixed(2) + '%';
    const fmtInt = num => new Intl.NumberFormat('en-US').format(num.toFixed(0));

    // v1.3 New: RMB formatter with 2 decimals
    const fmtRMB = num => '¥' + new Intl.NumberFormat('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(num);

    // --- GLOBAL DATA STORE FOR HIGH PRECISION ---
    window.latestCalc = {
        fixedCost: 0,
        commRate: 0,
        actualProfit: 0,
        prod: 0, log: 0, fba: 0, ret: 0, 
        price: 0, 
        ads_cpc: 0,
        ads_cvr: 0,
        goal_budget: 0 // Added for Tab Mix
    };

    const DATA_FIELDS = [
        'inp_purchase', 'inp_rate', 'inp_freight', 'inp_fba', 'inp_other',
        'inp_ret_rate', 'inp_unsell', 'inp_acos', 'inp_margin', 'inp_manual_comm',
        'inp_actual_price', 'inp_ret_proc', 'inp_ret_rem', 
        'ads_budget', 'ads_cpc', 'ads_cvr',
        'goal_cpc', 'goal_cvr', 
        'mix_sp_cpc', 'mix_sp_cvr', 'mix_sp_ctr',
        'guard_acos', 'guard_cpc',
        'sim_cpc', 'sim_cvr',
        'promo_price', 'promo_cvr', 'promo_cpc',
        'p_m1_units', 'p_m2_units', 'p_m3_units',
        'p_m1_ad_share', 'p_m2_ad_share', 'p_m3_ad_share',
        'supply_lead_time'
    ];

    const DB_KEY = 'amazon_calc_db_v2';
    const AUTOSAVE_KEY = 'amazon_calc_draft_v26'; 
    const SNAPSHOT_KEY = 'goal_snapshots_v5';
    let snapCols = JSON.parse(localStorage.getItem('snap_cols_pref_v5') || '{"sales":true,"prod":true,"log":true,"fba":true,"ret":true,"comm":true,"ads":true,"cost":true,"profit":true,"margin":true,"roi":true}');
    let goalState = { mode: 'month', month_val: 0, day_val: 0 };
    
    // Chart Instances
    let chartPie = null;
    let chartWaterfall = null;
    let chartMixer = null;
    let chartCashFlow = null; // New Chart

    // Global State for Sensitivity CVR
    let currentSensCVR = 10; 

    window.onload = function() {
        try {
            loadAutoSave();
            loadGoalSnapshots();
            renderComparisonTable();
            smartInitPrice();
            calculate();
            setInterval(doAutoSave, 60000); 
            
            // Listeners for Mix Tab
            if($('sim_cpc')) $('sim_cpc').addEventListener('input', updateMixTab);
            if($('sim_cvr')) $('sim_cvr').addEventListener('input', updateMixTab);
            
            // Listeners for Promo Tab
            const promoIds = ['promo_price', 'promo_cvr', 'promo_cpc', 
                              'p_m1_units', 'p_m2_units', 'p_m3_units',
                              'p_m1_ad_share', 'p_m2_ad_share', 'p_m3_ad_share',
                              'supply_lead_time'];
            promoIds.forEach(id => {
                if($(id)) $(id).addEventListener('input', () => {
                     // Constraint Ad Share inputs
                     if (id.includes('ad_share')) {
                         let val = parseFloat($(id).value);
                         if (val < 0) $(id).value = 0;
                         if (val > 100) $(id).value = 100;
                     }
                     calcPromoTab();
                });
            });
            
            // Force calculation of Promo Tab on load to populate defaults
            calcPromoTab();
            
        } catch (e) {
            console.error("Initialization Error:", e);
            alert("系统初始化失败，请检查控制台日志: " + e.message);
        }
    };

    function toggleMixer() { $('mixer_module').classList.toggle('collapsed'); }
    function toggleGoal() { $('goal_module').classList.toggle('collapsed'); }
    
    // v1.3: Switch Tabs Logic
    function toggleChart() {
        const panel = $('chart_panel');
        const btn = $('btn_toggle_chart');
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
            btn.style.background = "#2c3e50";
        } else {
            panel.classList.add('active');
            btn.style.background = "#3498db";
            calculate(); 
        }
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.an-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.an-pane').forEach(p => p.classList.remove('active'));
        
        const btn = document.querySelector(`.an-tab[onclick="switchTab('${tabName}')"]`);
        if(btn) btn.classList.add('active');
        
        const pane = document.getElementById('tab_' + tabName);
        if(pane) pane.classList.add('active');
        
        if (tabName === 'mix') {
             updateMixTab();
        } else if (tabName === 'promo') {
             calcPromoTab();
        } else {
             calculate(); 
        }
    }

    // --- Sensitivity Control Functions ---
    function syncSensCVR(val) {
        currentSensCVR = parseFloat(val);
        $('sens_cvr_disp').innerText = currentSensCVR + '%';
        triggerSensUpdate();
    }
    
    function adjustSensCVR(delta) {
        let newVal = parseFloat($('sens_cvr_slider').value) + delta;
        if(newVal < 1) newVal = 1;
        if(newVal > 100) newVal = 100;
        $('sens_cvr_slider').value = newVal;
        syncSensCVR(newVal);
    }
    
    function resetSensCVR() {
        const baseCVR = parse('ads_cvr');
        $('sens_cvr_slider').value = baseCVR;
        syncSensCVR(baseCVR);
    }

    function triggerSensUpdate() {
        const price = parse('inp_actual_price');
        const cpc = parse('ads_cpc');
        const comm = window.latestCalc.commRate;
        const fixed = window.latestCalc.fixedCost; 
        renderSensitivityMatrix(price, cpc, fixed, comm, currentSensCVR/100);
    }
    // --------------------------------------------

    function getSnapshots() { return JSON.parse(localStorage.getItem(SNAPSHOT_KEY) || '[]'); }
    function parseMoneyStr(id) { return parseFloat($(id).innerText.replace(/[$,¥,]/g, '')) || 0; }
    
    function captureGoalSnapshot() {
        const units = $('goal_units').value;
        if (units <= 0) { alert("请先输入有效的预估销量"); return; }
        const rate = parse('inp_rate') || 1;
        const salesUSD = parseMoneyStr('gb_sales');
        const prodUSD = parseMoneyStr('gb_prod');
        const logUSD = parseMoneyStr('gb_log');
        const fbaUSD = parseMoneyStr('gb_fba');
        const retUSD = parseMoneyStr('gb_ret');
        const commUSD = parseMoneyStr('gb_comm');
        const adsUSD = parseMoneyStr('gb_ads'); 
        const costUSD = parseMoneyStr('gb_total_cost');
        const profitUSD = parseMoneyStr('gb_profit');
        const margin = (parseFloat($('gb_profit_pct').innerText) || 0).toFixed(1) + '%';
        const roi = $('val_roi').innerText;
        const snapshot = {
            id: Date.now(), sku: '', units: units,
            sales: { usd: salesUSD, rmb: salesUSD * rate },
            prod: { usd: prodUSD, rmb: prodUSD * rate },
            log: { usd: logUSD, rmb: logUSD * rate },
            fba: { usd: fbaUSD, rmb: fbaUSD * rate },
            ret: { usd: retUSD, rmb: retUSD * rate },
            comm: { usd: commUSD, rmb: commUSD * rate },
            ads: { usd: adsUSD, rmb: adsUSD * rate },
            cost: { usd: costUSD, rmb: costUSD * rate },
            profit: { usd: profitUSD, rmb: profitUSD * rate },
            margin: margin, roi: roi, isProfit: profitUSD >= 0
        };
        const list = getSnapshots(); list.push(snapshot);
        localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(list)); renderGoalSnapshots();
    }
    function deleteSnapshot(id) {
        let list = getSnapshots(); list = list.filter(item => item.id !== id);
        localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(list)); renderGoalSnapshots();
    }
    function clearGoalSnapshots() {
        if(confirm('确定清空对比记录吗？')) { localStorage.setItem(SNAPSHOT_KEY, '[]'); renderGoalSnapshots(); }
    }
    function loadGoalSnapshots() { renderGoalSnapshots(); }
    function toggleSnapCol(col) {
        snapCols[col] = !snapCols[col]; localStorage.setItem('snap_cols_pref_v5', JSON.stringify(snapCols)); renderGoalSnapshots();
    }
    function renderGoalSnapshots() {
        const list = getSnapshots(); const container = $('goal_snapshot_area'); const tbody = $('goal_snapshot_tbody');
        tbody.innerHTML = '';
        if (list.length === 0) { container.style.display = 'none'; return; }
        container.style.display = 'block';
        
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            const col = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
            if(snapCols[col]) btn.classList.add('active'); else btn.classList.remove('active');
        });
        
        document.querySelectorAll('#snap_table th[data-col]').forEach(th => {
            const col = th.getAttribute('data-col'); th.style.display = snapCols[col] ? '' : 'none';
        });

        const radios = document.getElementsByName('snap_currency');
        let currencyMode = 'usd'; for(let r of radios) { if(r.checked) currencyMode = r.value; }
        const sym = currencyMode === 'rmb' ? '¥' : '$';
        
        const fmtMoney = (val) => sym + new Intl.NumberFormat('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(val);
        
        list.forEach(item => {
            const tr = document.createElement('tr'); const profitColor = item.isProfit ? '#27ae60' : '#e74c3c';
            const v = (obj) => currencyMode === 'rmb' ? obj.rmb : obj.usd;
            tr.innerHTML = `
                <td><input type="text" class="sku-input" placeholder="方案名称..." value="${item.sku || ''}" onchange="updateSnapshotSku(${item.id}, this.value)"></td>
                <td style="font-weight:bold;">${item.units}</td>
                <td class="${snapCols.sales?'':'col-hidden'}">${fmtMoney(v(item.sales))}</td>
                <td class="${snapCols.prod?'':'col-hidden'}">${fmtMoney(v(item.prod))}</td>
                <td class="${snapCols.log?'':'col-hidden'}">${fmtMoney(v(item.log))}</td>
                <td class="${snapCols.fba?'':'col-hidden'}">${fmtMoney(v(item.fba))}</td>
                <td class="${snapCols.ret?'':'col-hidden'}">${fmtMoney(v(item.ret))}</td>
                <td class="${snapCols.comm?'':'col-hidden'}">${fmtMoney(v(item.comm))}</td>
                <td class="${snapCols.ads?'':'col-hidden'}" style="color:#e67e22; font-weight:800;">${fmtMoney(v(item.ads))}</td>
                <td class="${snapCols.cost?'':'col-hidden'}">${fmtMoney(v(item.cost))}</td>
                <td class="${snapCols.profit?'':'col-hidden'}" style="font-weight:800; color:${profitColor}">${fmtMoney(v(item.profit))}</td>
                <td class="${snapCols.margin?'':'col-hidden'}">${item.margin}</td>
                <td class="${snapCols.roi?'':'col-hidden'}">${item.roi}</td>
                <td><button class="btn-del-snap" onclick="deleteSnapshot(${item.id})">×</button></td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function updateSnapshotSku(id, val) {
        const list = getSnapshots(); const item = list.find(x => x.id === id);
        if(item) { item.sku = val; localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(list)); }
    }
    
    function exportSnapshotsToExcel() {
        const list = getSnapshots(); if(list.length === 0) { alert("暂无记录可导出"); return; }
        const radios = document.getElementsByName('snap_currency'); let currencyMode = 'usd'; for(let r of radios) { if(r.checked) currencyMode = r.value; }
        const sym = currencyMode === 'rmb' ? 'CNY' : 'USD';
        let headers = ['Plan Name', 'Units'];
        if(snapCols.sales) headers.push(`Sales (${sym})`); if(snapCols.prod) headers.push(`Product Cost (${sym})`);
        if(snapCols.log) headers.push(`Logistics (${sym})`); if(snapCols.fba) headers.push(`FBA Fee (${sym})`);
        if(snapCols.ret) headers.push(`Return Cost (${sym})`); if(snapCols.comm) headers.push(`Commission (${sym})`);
        if(snapCols.ads) headers.push(`Ads Cost (${sym})`); if(snapCols.cost) headers.push(`Total Cost (${sym})`);
        if(snapCols.profit) headers.push(`Net Profit (${sym})`); if(snapCols.margin) headers.push('Margin'); if(snapCols.roi) headers.push('ROI');
        let csvContent = "\uFEFF" + headers.join(",") + "\n";
        list.forEach(item => {
            let row = [`"${item.sku || 'N/A'}"`, item.units]; const v = (obj) => currencyMode === 'rmb' ? obj.rmb : obj.usd;
            if(snapCols.sales) row.push(v(item.sales).toFixed(2)); if(snapCols.prod) row.push(v(item.prod).toFixed(2));
            if(snapCols.log) row.push(v(item.log).toFixed(2)); if(snapCols.fba) row.push(v(item.fba).toFixed(2));
            if(snapCols.ret) row.push(v(item.ret).toFixed(2)); if(snapCols.comm) row.push(v(item.comm).toFixed(2));
            if(snapCols.ads) row.push(v(item.ads).toFixed(2)); if(snapCols.cost) row.push(v(item.cost).toFixed(2));
            if(snapCols.profit) row.push(v(item.profit).toFixed(2)); if(snapCols.margin) row.push(item.margin.replace('%','')); if(snapCols.roi) row.push(item.roi.replace('%',''));
            csvContent += row.join(",") + "\n";
        });
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Amazon_Plan_Compare_${sym}_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    }
    
    function exportData() { 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([JSON.stringify(getDB(), null, 2)], {type: "application/json"})); 
        a.download = "amazon_backup.json"; 
        a.click(); 
    }
    
    function importData(input) { 
        const file = input.files[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                saveDB({ ...getDB(), ...JSON.parse(e.target.result) }); 
                renderComparisonTable(); 
                alert('导入成功'); 
            } catch(err) { 
                alert('文件错误'); 
            } 
        }; 
        reader.readAsText(file); 
    }
    
    DATA_FIELDS.forEach(id => { 
        if(id !== 'goal_units') { 
            const el = $(id); 
            if(el) { 
                el.addEventListener('input', (event) => { 
                    if(event.target.id === 'ads_cpc') $('goal_cpc').value = event.target.value; 
                    if(event.target.id === 'ads_cvr') $('goal_cvr').value = event.target.value; 
                    calculate(); 
                }); 
            } 
        } 
    });
    
    $('chk_auto_comm').addEventListener('change', () => { updateCommState(); calculate(); });
    
    function updateCommState() { 
        const isAuto = $('chk_auto_comm').checked; 
        const inp = $('inp_manual_comm'); 
        if (isAuto) { 
            inp.readOnly = true; 
            inp.style.background = "#eee"; 
            inp.style.color="#999"; 
        } else { 
            inp.readOnly = false; 
            inp.style.background = "var(--input-bg)"; 
            inp.style.color="#333"; 
        } 
    }
    
    function getRefundAdminFee(price, commRate) { if (price <= 0) return 0; return Math.min(5.00, (price * commRate) * 0.20); }
    function getAvgRetCost(R, costProd, price, commRate) { const retAdminFee = getRefundAdminFee(price, commRate); const lossSellable = R.retProc + retAdminFee + R.fba; const lossUnsellable = lossSellable + costProd + R.freight + R.retRem; const weightedLoss = (lossSellable * (1 - R.unsell)) + (lossUnsellable * R.unsell); return weightedLoss * R.retRate; }

    function calculate() {
        let rate = parse('inp_rate'); 
        if (rate <= 0) rate = 1; 
        
        const R = { 
            purRMB: parse('inp_purchase'), 
            rate: rate, 
            freight: parse('inp_freight'), 
            fba: parse('inp_fba'), 
            other: parse('inp_other'), 
            retRate: parse('inp_ret_rate')/100, 
            unsell: parse('inp_unsell')/100, 
            acos: parse('inp_acos')/100, 
            targetMargin: parse('inp_margin')/100, 
            retProc: parse('inp_ret_proc'), 
            retRem: parse('inp_ret_rem') 
        };
        
        const isAutoComm = $('chk_auto_comm').checked; 
        const costProd = R.purRMB / R.rate; 
        $('disp_usd_cost').innerText = fmtUSD(costProd);
        
        const baseFixedCost = costProd + R.freight + R.fba + R.other;

        // Plan A logic
        let targetPrice = 20.00, targetComm = 0.17;
        for(let i=0; i<5; i++) { 
            if (isAutoComm) { 
                if (targetPrice > 20) targetComm = 0.17; else if (targetPrice >= 15) targetComm = 0.10; else targetComm = 0.05; 
            } else { 
                targetComm = parse('inp_manual_comm') / 100; 
            } 
            const avgRetCost = getAvgRetCost(R, costProd, targetPrice, targetComm); 
            const totalFixed = baseFixedCost + avgRetCost; 
            let denom = 1 - targetComm - R.acos - R.targetMargin; 
            if (denom <= 0.01) denom = 0.01; 
            targetPrice = totalFixed / denom; 
        }
        
        if(isAutoComm) $('inp_manual_comm').value = (targetComm * 100).toFixed(0);
        
        const avgRetCost_A = getAvgRetCost(R, costProd, targetPrice, targetComm); 
        const fixedCost_A = baseFixedCost + avgRetCost_A;
        
        $('res_target_price').innerText = fmtUSD(targetPrice); 
        $('txt_target_margin').innerText = fmtPct(R.targetMargin); 
        $('comm_target').innerText = (targetComm * 100).toFixed(0) + '%'; 
        $('be_target').innerText = fmtUSD(fixedCost_A / (1 - targetComm));
        
        renderTable('table_target', targetPrice, fixedCost_A, costProd, R.freight+R.other, R.fba, avgRetCost_A, targetComm, R.acos);
        
        const vProfitA = targetPrice - fixedCost_A - (targetPrice * targetComm) - (targetPrice * R.acos); 
        const vCostA = baseFixedCost + avgRetCost_A + (targetPrice * targetComm);
        
        $('profit_target_display').innerText = fmtUSD(vProfitA); 
        $('profit_target_display').style.color = vProfitA >= 0 ? 'var(--success)' : 'var(--danger)'; 
        $('cost_target').innerText = fmtUSD(vCostA);

        // Plan B logic
        let actualPrice = parse('inp_actual_price'); 
        let actualComm = 0.17; 
        if (isAutoComm) { 
            if (actualPrice > 20) actualComm = 0.17; else if (actualPrice >= 15) actualComm = 0.10; else actualComm = 0.05; 
        } else { 
            actualComm = parse('inp_manual_comm') / 100; 
        }
        
        const refAdminFee_B = getRefundAdminFee(actualPrice, actualComm); 
        $('disp_ret_admin').value = refAdminFee_B.toFixed(2);
        
        const avgRetCost_B = getAvgRetCost(R, costProd, actualPrice, actualComm); 
        const fixedCost_B = baseFixedCost + avgRetCost_B;
        
        const costComm = actualPrice * actualComm; 
        const costAds = actualPrice * R.acos; 
        const actualProfit = actualPrice - fixedCost_B - costComm - costAds; 
        const actualMargin = actualPrice > 0 ? (actualProfit / actualPrice) : 0;
        
        // STORE HIGH PRECISION DATA
        window.latestCalc = { 
            fixedCost: fixedCost_B, 
            commRate: actualComm, 
            actualProfit: actualProfit,
            prod: costProd,
            log: R.freight + R.other,
            fba: R.fba,
            ret: avgRetCost_B,
            price: actualPrice,
            ads_cpc: parse('ads_cpc'),
            ads_cvr: parse('ads_cvr') / 100,
            goal_budget: 0 // Will be set in calcGoal
        };

        $('raw_plan_b_profit').value = actualProfit.toFixed(2); 
        $('txt_actual_margin').innerText = fmtPct(actualMargin); 
        $('txt_actual_margin').style.color = actualProfit < 0 ? '#e74c3c' : '#27ae60'; 
        $('comm_actual').innerText = (actualComm * 100).toFixed(0) + '%'; 
        $('be_actual').innerText = fmtUSD(fixedCost_B / (1 - actualComm));
        
        renderTable('table_actual', actualPrice, fixedCost_B, costProd, R.freight+R.other, R.fba, avgRetCost_B, actualComm, R.acos);
        
        const vCostB = baseFixedCost + avgRetCost_B + costComm; 
        $('profit_actual_display').innerText = fmtUSD(actualProfit); 
        $('profit_actual_display').style.color = actualProfit >= 0 ? 'var(--success)' : 'var(--danger)'; 
        $('cost_actual').innerText = fmtUSD(vCostB);

        const planB_Data = { price: actualPrice, prod: costProd, log: R.freight + R.other, fba: R.fba, ret: avgRetCost_B, comm: costComm, profit: actualProfit, rate: rate };
        
        calcGoal(planB_Data); 
        calcAdsFull(actualPrice, fixedCost_B, actualComm);

        if(document.activeElement.id !== 'sens_cvr_slider') {
             resetSensCVR(); 
        } else {
             triggerSensUpdate();
        }
        
        // Trigger Mix Tab Update if active
        if(document.getElementById('tab_mix').classList.contains('active')) {
            updateMixTab();
        }
        
        // Trigger Promo Tab Update if active
        if(document.getElementById('tab_promo').classList.contains('active')) {
             calcPromoTab();
        }
    }

    function calcGoal(data) { 
        if (!data || data.price <= 0) { $('goal_current_price').innerText = '$0.00'; return; }
        $('goal_current_price').innerText = fmtUSD(data.price);
        
        let units = parse('goal_units'); 
        if (units < 0) units = 0; 
        const rate = data.rate || 7.1;
        
        const total_Sales = units * data.price; 
        let targetTACOS = parse('inp_acos');
        
        const total_Budget = total_Sales * (targetTACOS / 100);
        window.latestCalc.goal_budget = total_Budget; // Store for Mix tab
        
        const total_Prod = units * data.prod; 
        const total_Log = units * data.log; 
        const total_Fba = units * data.fba;
        const total_Ret = units * data.ret; 
        const total_Comm = units * data.comm; 
        const total_Ads = total_Budget; 
        
        const total_Cost_All = total_Prod + total_Log + total_Fba + total_Ret + total_Comm + total_Ads;
        const total_Profit = total_Sales - total_Cost_All;

        const updateUI = (suffix, usdVal, totalSalesVal) => {
            const elUsd = $('gb_' + suffix); 
            const elRmb = $('gb_' + suffix + '_rmb'); 
            const elPct = $('gb_' + suffix + '_pct');
            
            if(elUsd) elUsd.innerText = fmtIntUSD(usdVal); 
            // v1.3: RMB with 2 decimals
            if(elRmb) elRmb.innerText = fmtRMB(usdVal * rate); 
            
            if(elPct && suffix !== 'sales') { 
                const pct = totalSalesVal > 0 ? (usdVal / totalSalesVal) * 100 : 0; 
                elPct.innerText = pct.toFixed(1) + '%'; 
            }
        };
        const fmtIntUSD = (num) => '$' + new Intl.NumberFormat('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(num);
        
        updateUI('sales', total_Sales, total_Sales); 
        updateUI('prod', total_Prod, total_Sales); 
        updateUI('log', total_Log, total_Sales); 
        updateUI('fba', total_Fba, total_Sales); 
        updateUI('ret', total_Ret, total_Sales); 
        updateUI('comm', total_Comm, total_Sales); 
        updateUI('ads', total_Ads, total_Sales); 
        updateUI('total_cost', total_Cost_All, total_Sales); 
        updateUI('profit', total_Profit, total_Sales);
        
        $('gb_profit').style.color = total_Profit >= 0 ? '#27ae60' : '#e74c3c';
        
        // Update All Charts
        const chartData = { prod: total_Prod, log: total_Log + total_Fba, ret: total_Ret, comm: total_Comm, ads: total_Ads, profit: total_Profit, sales: total_Sales };
        updatePieChart(chartData);
        updateWaterfallChart(chartData);
        // Mixer chart is now handled by updateMixTab called at end of calculate

        const roi = total_Cost_All > 0 ? (total_Profit / total_Cost_All) * 100 : 0; 
        $('val_roi').innerText = roi.toFixed(1) + '%'; 
        $('val_roi').style.color = roi > 0 ? '#27ae60' : '#e74c3c';
        
        const roas = total_Ads > 0 ? (total_Sales / total_Ads) : 0; 
        $('val_roas').innerText = roas.toFixed(2);
        
        const capEff = total_Prod > 0 ? (total_Sales / total_Prod) * 100 : 0; 
        $('val_capital_efficiency').innerText = capEff.toFixed(0) + '%';
        
        const costWithoutAds = total_Prod + total_Log + total_Fba + total_Ret + total_Comm; 
        const breakEvenAdSpend = total_Sales - costWithoutAds; 
        const beRoas = breakEvenAdSpend > 0 ? (total_Sales / breakEvenAdSpend) : 999; 
        $('val_be_roas').innerText = beRoas.toFixed(2);
        
        calcMixer(total_Budget, units, data.price);
    }
    
    // v1.3: Updated Charts Logic
    function updatePieChart(data) {
        if (!$('chart_panel').classList.contains('active') || !document.querySelector('#tab_pie').classList.contains('active')) return;
        
        const ctx = document.getElementById('goalPieChart').getContext('2d');
        const profitVal = Math.max(0, data.profit);
        
        const configData = { 
            labels: ['采购', '物流/FBA', '退货', '佣金', '广告', '净利'], 
            datasets: [{ 
                data: [data.prod, data.log, data.ret, data.comm, data.ads, profitVal], 
                backgroundColor: ['#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#f1c40f', '#27ae60'], 
                borderWidth: 1 
            }] 
        };
        
        if (chartPie) { chartPie.data = configData; chartPie.update(); } 
        else { 
            chartPie = new Chart(ctx, { 
                type: 'doughnut', data: configData, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } } } 
            }); 
        }
    }

    function updateWaterfallChart(data) {
        if (!$('chart_panel').classList.contains('active') || !document.querySelector('#tab_waterfall').classList.contains('active')) return;

        const ctx = document.getElementById('waterfallChart').getContext('2d');
        
        const S = data.sales;
        const C_Prod = data.prod;
        
        let current = S;
        const waterfallData = [];
        const bgColors = [];
        
        waterfallData.push([0, S]); bgColors.push('#34495e'); current = S;
        waterfallData.push([current - C_Prod, current]); bgColors.push('#3498db'); current -= C_Prod;
        waterfallData.push([current - data.log, current]); bgColors.push('#9b59b6'); current -= data.log;
        waterfallData.push([current - data.ret, current]); bgColors.push('#e74c3c'); current -= data.ret;
        waterfallData.push([current - data.comm, current]); bgColors.push('#f39c12'); current -= data.comm;
        waterfallData.push([current - data.ads, current]); bgColors.push('#f1c40f'); current -= data.ads;
        waterfallData.push([0, current]); bgColors.push(current >= 0 ? '#27ae60' : '#c0392b');

        const labels = ['销售总额', '采购成本', '物流配送', '退货损耗', '平台佣金', '广告花费', '净利润'];

        if (chartWaterfall) {
            chartWaterfall.data.datasets[0].data = waterfallData;
            chartWaterfall.data.datasets[0].backgroundColor = bgColors;
            chartWaterfall.update();
        } else {
            chartWaterfall = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: waterfallData,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const raw = context.raw;
                                    const val = raw[1] - raw[0];
                                    return context.label + ': $' + val.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    }

    // --- New Function: Update Mix Tab (Integrated with new J-Curve and Manual Inputs) ---
    function updateMixTab() {
        if (!$('chart_panel').classList.contains('active') || !document.querySelector('#tab_mix').classList.contains('active')) return;

        const price = window.latestCalc.price;
        const totalBudget = window.latestCalc.goal_budget;
        const totalUnits = parse('goal_units') || 0;
        
        // Manual Inputs for Simulation
        const simCpc = parse('sim_cpc');
        const simCvr = parse('sim_cvr') / 100;
        
        $('mix_disp_budget').innerText = fmtUSD(totalBudget);
        $('mix_disp_budget').style.color = totalBudget > 0 ? '#34495e' : '#999';

        if (simCvr <= 0 || simCpc <= 0 || price <= 0) return;

        // Calculate Cost Per Acquisition (CPA)
        const cpa = simCpc / simCvr;
        
        // Calculate Max Ad Orders based on Budget
        let adOrders = 0;
        if(cpa > 0) adOrders = totalBudget / cpa;
        
        const realAdOrders = Math.min(adOrders, totalUnits);
        const adShare = totalUnits > 0 ? (realAdOrders / totalUnits) * 100 : 0;
        const organicOrders = Math.max(0, totalUnits - realAdOrders);
        
        $('mix_disp_ad_orders').innerText = realAdOrders.toFixed(2);
        
        // Unit Economics
        const fixedCostPerUnit = window.latestCalc.fixedCost + (price * window.latestCalc.commRate); // Prod + Log + FBA + Ret + Comm
        const profitOrganic = price - fixedCostPerUnit;
        const profitAd = profitOrganic - cpa;
        
        // Break Even Point Calculation
        // Total Profit = (AdOrders * ProfitAd) + (OrganicOrders * ProfitOrganic)
        // If Ad Loop is profitable, BEP is instant (0).
        // If Ad Loop is negative, we need X organic orders to cover Ad loss.
        let bepOrders = 0;
        const totalAdLoss = realAdOrders * profitAd;
        
        if (totalAdLoss < 0) {
             const neededOrganicToCover = Math.abs(totalAdLoss) / Math.max(0.01, profitOrganic);
             bepOrders = realAdOrders + neededOrganicToCover;
        }
        
        $('mix_disp_org_orders').innerText = organicOrders.toFixed(2);
        $('mix_disp_bep_orders').innerText = bepOrders.toFixed(1);

        $('mix_warning_text').innerText = profitAd < 0 
            ? `⚠️ 警告: 广告单亏损 $${Math.abs(profitAd).toFixed(2)}/单，需要 ${((Math.abs(profitAd)*realAdOrders)/Math.max(0.01, profitOrganic)).toFixed(0)} 个自然单填坑。`
            : "✅ 状态良好: 广告单本身盈利。";
            
        // --- 1. J-Curve (Cash Flow) Chart Update ---
        updateCashFlowChart(totalUnits, realAdOrders, profitAd, profitOrganic);

        // --- 2. Advanced Strategic Mix Chart ---
        const orgNeeded = parse('mix_org_needed'); // From the GAP analysis
        updateMixerSensitivityChart(price, simCpc, simCvr, fixedCostPerUnit, totalBudget, orgNeeded);
    }

    function updateCashFlowChart(totalUnits, adOrders, profitAd, profitOrganic) {
        const ctx = document.getElementById('cashFlowChart').getContext('2d');
        
        // Generate Points
        const p0 = { x: 0, y: 0 };
        const adPhaseProfit = adOrders * profitAd;
        const p1 = { x: adOrders, y: adPhaseProfit };
        const organicPhaseProfit = (totalUnits - adOrders) * profitOrganic;
        const p2 = { x: totalUnits, y: adPhaseProfit + organicPhaseProfit };
        
        // Break Even Point Logic
        let bePoint = null;
        if (p1.y < 0 && p2.y > 0) {
            const xOffset = -p1.y / profitOrganic;
            bePoint = { x: p1.x + xOffset, y: 0 };
        } 
        
        const dataPoints = [p0, p1, p2];

        const datasets = [{
            label: '资金曲线',
            data: dataPoints,
            borderColor: '#3498db',
            borderWidth: 2,
            tension: 0.3,
            fill: {
                target: 'origin',
                above: 'rgba(39, 174, 96, 0.3)',
                below: 'rgba(231, 76, 60, 0.3)'
            },
            pointRadius: 0,
            hoverRadius: 0
        }];
        
        datasets.push({
            label: '最大投入',
            data: [{x: p1.x, y: p1.y}],
            backgroundColor: 'red',
            borderColor: 'white',
            borderWidth: 2,
            pointRadius: 6,
            hoverRadius: 8,
            type: 'scatter'
        });

        if (bePoint) {
            datasets.push({
                label: '盈亏平衡',
                data: [{x: bePoint.x, y: bePoint.y}],
                backgroundColor: '#2980b9',
                borderColor: 'white',
                borderWidth: 2,
                pointRadius: 6,
                hoverRadius: 8,
                type: 'scatter'
            });
        }

        const tooltipCallback = (context) => {
             const label = context.dataset.label || '';
             const x = context.parsed.x.toFixed(1);
             const y = context.parsed.y.toFixed(2);
             if (label && label !== '资金曲线') {
                 return `${label}: 销量 ${x}, 资金 $${y}`;
             }
             return `销量: ${x}, 资金: $${y}`;
        };

        if (chartCashFlow) {
            chartCashFlow.data.datasets = datasets;
            chartCashFlow.options.scales.x.max = totalUnits * 1.1;
            
            // Dynamic update of tooltip config to fix the issue without reload
            chartCashFlow.options.plugins.tooltip.filter = null; 
            chartCashFlow.options.plugins.tooltip.callbacks.label = tooltipCallback;
            chartCashFlow.options.plugins.tooltip.displayColors = false;
            
            chartCashFlow.update();
        } else {
            chartCashFlow = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            displayColors: false,
                            mode: 'nearest',
                            intersect: true,
                            callbacks: {
                                title: () => '',
                                label: tooltipCallback
                            }
                        }
                    },
                    scales: {
                        x: { 
                            type: 'linear', 
                            title: { display: true, text: '累计销量 (Units)' },
                            min: 0
                        },
                        y: { 
                            title: { display: true, text: '资金池 ($)' }
                        }
                    }
                }
            });
        }
    }

    function updateMixerSensitivityChart(price, currentSimCpc, cvr, unitCost, totalBudget, baseOrganicUnits) {
        const ctx = document.getElementById('mixerChart').getContext('2d');
        
        const steps = [];
        const maxCpc = Math.max(3.5, currentSimCpc * 2.5);
        for(let c = 0.1; c <= maxCpc; c += 0.2) {
             steps.push(parseFloat(c.toFixed(2)));
        }
        if (!steps.includes(currentSimCpc)) {
            steps.push(currentSimCpc);
            steps.sort((a,b) => a - b);
        }

        const profitData = [];
        const volumeData = [];
        const bgColors = [];
        const borderColors = [];
        const borderWidths = [];

        const marketRefCpc = Math.max(0.5, currentSimCpc);
        const goalUnits = parseFloat(document.getElementById('goal_units').value) || 100;
        const maxMarketClicks = (goalUnits / (cvr || 0.1)) * 1.5; 

        let maxProfitVal = -Infinity;

        steps.forEach((cpc, idx) => {
            const bidRatio = cpc / marketRefCpc;
            let winRate = 1 / (1 + Math.exp(-4 * (bidRatio - 0.7))); 
            
            const volumeLimitedClicks = maxMarketClicks * winRate;
            const budgetLimitedClicks = cpc > 0 ? totalBudget / cpc : 0;
            const actualClicks = Math.min(volumeLimitedClicks, budgetLimitedClicks);
            
            const adOrders = actualClicks * cvr;
            const totalUnits = (baseOrganicUnits || 0) + adOrders;
            
            const revenue = totalUnits * price;
            const totalFixedCost = totalUnits * unitCost; 
            const actualSpend = actualClicks * cpc;       
            const totalCost = totalFixedCost + actualSpend;
            const netProfit = revenue - totalCost;
            
            profitData.push(netProfit);
            volumeData.push(totalUnits);
            
            if(netProfit > maxProfitVal) maxProfitVal = netProfit;
        });

        steps.forEach((cpc, idx) => {
            const netProfit = profitData[idx];
            const isSelected = Math.abs(cpc - currentSimCpc) < 0.001;

            if (isSelected) {
                borderColors.push('#2c3e50'); 
                borderWidths.push(3);
            } else {
                borderColors.push('transparent');
                borderWidths.push(0);
            }

            if (netProfit < 0) {
                bgColors.push('#e74c3c'); 
            } else if (netProfit === maxProfitVal) {
                bgColors.push('#f1c40f'); 
            } else if (netProfit < maxProfitVal * 0.3) {
                bgColors.push('#95a5a6'); 
            } else {
                bgColors.push('#2ecc71'); 
            }
        });

        if (typeof chartMixer !== 'undefined' && chartMixer) {
            chartMixer.data.labels = steps.map(s => '$' + s.toFixed(2));
            chartMixer.data.datasets[0].data = profitData;
            chartMixer.data.datasets[0].backgroundColor = bgColors;
            chartMixer.data.datasets[0].borderColor = borderColors;
            chartMixer.data.datasets[0].borderWidth = borderWidths;
            chartMixer.data.datasets[1].data = volumeData;
            chartMixer.update();
        } else {
            const config = {
                type: 'bar',
                data: {
                    labels: steps.map(s => '$' + s.toFixed(2)),
                    datasets: [
                        {
                            label: '总净利润 ($)',
                            data: profitData,
                            backgroundColor: bgColors,
                            borderColor: borderColors,
                            borderWidth: borderWidths,
                            order: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: '预估销量 (Units)',
                            data: volumeData,
                            type: 'line',
                            borderColor: '#8e44ad', 
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            tension: 0.4,
                            order: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { boxWidth: 10, usePointStyle: true } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: (ctx) => `CPC 出价: ${ctx[0].label}`,
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        if(context.dataset.type === 'line') {
                                             return `预估销量: ${context.parsed.y.toFixed(1)} 单`;
                                        } else {
                                             return `总净利: $${new Intl.NumberFormat('en-US').format(context.parsed.y.toFixed(2))}`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: '模拟 CPC (低价无流量 -> 高价无预算)' },
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '总净利润 ($)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '销量 (Units)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            };
            chartMixer = new Chart(ctx, config);
        }
    }
    
    // --- New Function: Promotion Analysis Tab Calculation ---
    function calcPromoTab() {
        if (!$('chart_panel').classList.contains('active') || !document.querySelector('#tab_promo').classList.contains('active')) return;
        
        // 1. Get Inputs
        const pPrice = parse('promo_price');
        const pCvr = parse('promo_cvr') / 100;
        const pCpc = parse('promo_cpc');
        
        // 2. Get Base Costs from Window Global (Plan B data)
        const C = window.latestCalc;
        
        // Dynamic Commission Logic
        const isAutoComm = $('chk_auto_comm').checked;
        let pCommRate = C.commRate; // Default to Plan B rate
        
        if (isAutoComm) {
            // Re-evaluate clothing tiers based on promo price
            if (pPrice > 20) pCommRate = 0.17; 
            else if (pPrice >= 15) pCommRate = 0.10; 
            else pCommRate = 0.05;
        }
        
        const pComm = round2(pPrice * pCommRate);
        
        // Re-calculate Return Cost based on Promo Price (using inputs directly for safety)
        const retAdmin = getRefundAdminFee(pPrice, pCommRate);
        const R_input = {
             purRMB: parse('inp_purchase'),
             rate: parse('inp_rate') || 1,
             freight: parse('inp_freight'),
             retRate: parse('inp_ret_rate')/100,
             unsell: parse('inp_unsell')/100,
             retProc: parse('inp_ret_proc'),
             retRem: parse('inp_ret_rem'),
             fba: parse('inp_fba')
        };
        const costProd = round2(R_input.purRMB / R_input.rate);
        const logCost = round2(R_input.freight + parse('inp_other'));
        
        const lossSellable = R_input.retProc + retAdmin + R_input.fba;
        const lossUnsellable = lossSellable + costProd + R_input.freight + R_input.retRem;
        const weightedLoss = (lossSellable * (1 - R_input.unsell)) + (lossUnsellable * R_input.unsell);
        const pRet = round2(weightedLoss * R_input.retRate);

        const pCpa = pCvr > 0 ? round2(pCpc / pCvr) : 0;
        
        // Gross Profit (Organic) = Price - COGS - FBA - Comm - Ret
        // COGS here includes product cost + logistics
        const pGross = round2(pPrice - costProd - logCost - R_input.fba - pComm - pRet);
        
        // Net Profit (Ads) = Gross - CPA
        const pNetAd = round2(pGross - pCpa);
        
        // Update Left Side UI
        $('pd_price').innerText = fmtUSD(pPrice);
        $('pd_prod').innerText = fmtUSD(costProd);
        $('pd_log').innerText = fmtUSD(logCost);
        $('pd_fba').innerText = fmtUSD(R_input.fba);
        $('pd_comm').innerText = fmtUSD(pComm);
        $('pd_ret').innerText = fmtUSD(pRet);
        $('pd_cpa').innerText = fmtUSD(pCpa);
        
        $('pd_gross_profit').innerText = fmtUSD(pGross);
        $('pd_net_profit').innerText = fmtUSD(pNetAd);
        
        // 3. Quarterly Strategy (Right Side)
        const m1_daily = parse('p_m1_units');
        const m1_share = parse('p_m1_ad_share') / 100;
        
        const m2_daily = parse('p_m2_units');
        const m2_share = parse('p_m2_ad_share') / 100;
        
        const m3_daily = parse('p_m3_units');
        const m3_share = parse('p_m3_ad_share') / 100;
        
        const calcMonth = (dailyUnits, share, elPrefix) => {
            const monthlyUnits = dailyUnits * 30;
            const adUnits = Math.round(monthlyUnits * share);
            const orgUnits = monthlyUnits - adUnits;
            
            const monthlyRevenue = round2(monthlyUnits * pPrice);
            const monthlySpend = round2(adUnits * pCpa);
            
            // Profit Calculation: (Org * Gross) + (Ad * (Gross - CPA))
            // Equivalent to: (TotalUnits * Gross) - Spend
            const totalGross = round2(monthlyUnits * pGross);
            const monthlyProfit = round2(totalGross - monthlySpend);
            
            const tacos = monthlyRevenue > 0 ? (monthlySpend / monthlyRevenue) * 100 : 0;
            
            $(elPrefix + '_spend').innerText = fmtUSD(monthlySpend);
            $(elPrefix + '_profit').innerText = fmtUSD(monthlyProfit);
            $(elPrefix + '_profit').style.color = monthlyProfit >= 0 ? '#2e7d32' : '#c62828';
            $(elPrefix + '_acos').innerText = "TACoS: " + tacos.toFixed(1) + "%";
            
            // Return COGS for summary (Revenue - Profit - Spend = COGS)
            // Or simpler: TotalUnits * (Prod + Log + FBA + Comm + Ret)
            // But Comm is dynamic... let's use deduction
            const monthlyCOGS = round2(monthlyRevenue - monthlyProfit - monthlySpend);

            return { units: monthlyUnits, revenue: monthlyRevenue, spend: monthlySpend, profit: monthlyProfit, cogs: monthlyCOGS };
        };
        
        const m1 = calcMonth(m1_daily, m1_share, 'p_m1');
        const m2 = calcMonth(m2_daily, m2_share, 'p_m2');
        const m3 = calcMonth(m3_daily, m3_share, 'p_m3');
        
        const totalUnits = m1.units + m2.units + m3.units;
        const totalRevenue = round2(m1.revenue + m2.revenue + m3.revenue);
        const totalSpend = round2(m1.spend + m2.spend + m3.spend);
        const totalProfit = round2(m1.profit + m2.profit + m3.profit);
        const totalCOGS = round2(m1.cogs + m2.cogs + m3.cogs);
        
        $('p_total_units').innerText = totalUnits;
        $('p_total_revenue').innerText = fmtUSD(totalRevenue);
        $('p_total_spend').innerText = fmtUSD(totalSpend);
        $('p_total_cogs').innerText = fmtUSD(totalCOGS);
        $('p_total_profit').innerText = fmtUSD(totalProfit);
        $('p_total_profit').className = totalProfit >= 0 ? 'sum-val sum-pos' : 'sum-val sum-neg';
        
        // 4. Recovery Calculation
        const regularUnitProfit = C.actualProfit; // From Plan B
        
        // Safe division check
        let unitsNeeded = 0;
        let daysNeeded = 0;
        
        if (totalProfit < 0 && regularUnitProfit > 0) {
            const loss = Math.abs(totalProfit);
            unitsNeeded = Math.ceil(loss / regularUnitProfit);
            
            if (m3_daily > 0) {
                daysNeeded = Math.ceil(unitsNeeded / m3_daily);
            } else {
                daysNeeded = 9999; // Infinite if no sales
            }
            
            $('rec_units').innerText = unitsNeeded;
            $('rec_days').innerText = daysNeeded > 9000 ? "∞" : daysNeeded;
            $('rec_months').innerText = daysNeeded > 9000 ? "" : `(约 ${(daysNeeded/30).toFixed(1)} 个月)`;
            
        } else if (totalProfit >= 0) {
             $('rec_units').innerText = "0";
             $('rec_days').innerText = "0";
             $('rec_months').innerText = "无需填坑";
        } else {
             $('rec_units').innerText = "∞"; 
             $('rec_days').innerText = "∞";
             $('rec_months').innerText = "Plan B 也在亏损";
        }

        // 5. Supply Chain & Capital Calculation
        // Logic: Launch Stock (M1+M2+M3) + Safety Stock (M3_Daily * LeadTime)
        // Capital = Stock * LandCost + Abs(NetLoss)
        
        const leadTime = parse('supply_lead_time');
        const promoStock = totalUnits;
        const safetyStock = m3_daily * leadTime;
        const totalStock = promoStock + safetyStock;
        
        // Land Cost = Product Cost + Logistics (Freight)
        const landCostPerUnit = costProd + R_input.freight;
        const stockCapital = round2(totalStock * landCostPerUnit);
        
        // Total Capital Exposure = Stock Cost + Burned Cash (Loss)
        // If Profit is positive, we don't add "burn", but initial stock is still needed.
        const burnAmount = totalProfit < 0 ? Math.abs(totalProfit) : 0;
        const maxCapital = round2(stockCapital + burnAmount);
        
        $('sup_promo_stock').innerText = promoStock;
        $('sup_safe_stock').innerText = safetyStock;
        $('sup_total_stock').innerText = totalStock;
        $('sup_total_capital').innerText = fmtUSD(maxCapital);
    }

    function renderTable(elId, price, fixed, cProd, cLog, cFba, cRet, rComm, rAds) {
        if (price <= 0) { $(elId).innerHTML = ''; return; }
        const vComm = price * rComm; 
        const vAds = price * rAds; 
        const vProfit = price - fixed - vComm - vAds;
        const rows = [ 
            { n:'采购', v:cProd, c:'c-prod' }, 
            { n:'物流', v:cLog, c:'c-log' }, 
            { n:'FBA', v:cFba, c:'c-fba' }, 
            { n:'佣金', v:vComm, c:'c-comm' }, 
            { n:'退货', v:cRet, c:'c-ret' }, 
            { n:'广告', v:vAds, c:'c-ads' }, 
            { n:'净利', v:vProfit, c:'c-prof', bold:true } 
        ];
        
        let html = ''; 
        rows.forEach(r => { 
            let pct = 0; 
            if (price > 0 && isFinite(r.v)) { pct = (r.v / price) * 100; } 
            const w = Math.max(0, Math.min(100, pct)); 
            html += `<tr><td class="row-name"><span class="dot ${r.c}"></span> ${r.n}</td><td class="row-val" style="${r.bold?'color:#27ae60':''}">${fmtUSD(r.v)}</td><td class="row-pct">${pct.toFixed(1)}%</td><td class="row-bar"><div class="progress-track"><div class="progress-fill ${r.c}" style="width:${w}%"></div></div></td></tr>`; 
        }); 
        $(elId).innerHTML = html;
    }

    function calcMixer(totalBudget, goalUnits, unitPrice) {
        if (totalBudget === undefined) totalBudget = 0; 
        
        $('mix_total_budget').innerText = fmtUSD(totalBudget); 
        $('mix_goal_units_display').innerText = goalUnits;
        
        const modeLabel = (goalState.mode === 'month') ? "月度目标预算" : "日均目标预算"; 
        $('mix_source_label').innerText = modeLabel;
        
        const guardACOS = parse('guard_acos'); 
        const guardCPC = parse('guard_cpc'); 
        const chBudget = totalBudget;
        
        const cpc = parse('mix_sp_cpc'); 
        const ctr = parse('mix_sp_ctr') / 100; 
        const cvr = parse('mix_sp_cvr') / 100;
        
        let clicks = 0; let orders = 0; let imp = 0; let acos = 0;
        
        if (cpc > 0 && chBudget > 0) { 
            clicks = chBudget / cpc; 
            orders = clicks * cvr; 
            if (ctr > 0) imp = clicks / ctr; 
            const sales = orders * unitPrice; 
            if (sales > 0) acos = (chBudget / sales) * 100; 
        }
        
        $('mix_sp_clicks').innerText = fmtInt(clicks); 
        $('mix_sp_imp').innerText = fmtInt(imp); 
        $('mix_sp_orders').innerText = orders.toFixed(1); 
        
        const acosEl = $('mix_sp_acos'); 
        acosEl.innerText = acos.toFixed(1) + '%';
        
        const statusEl = $('mix_sp_status'); 
        statusEl.innerText = "";
        
        if (cpc > guardCPC) { 
            statusEl.innerText = "⚠️ CPC过高"; statusEl.style.color = "red"; 
        } else if (guardACOS > 0 && acos > guardACOS) { 
            statusEl.innerText = "⚠️ ACOS超标"; statusEl.style.color = "red"; 
        } else if (chBudget > 0) { 
            statusEl.innerText = "✅ 正常"; statusEl.style.color = "#27ae60"; 
        }
        
        $('mix_total_ad_orders').innerText = orders.toFixed(1); 
        
        const orgNeeded = goalUnits - orders; 
        const orgEl = $('mix_org_needed'); 
        orgEl.innerText = orgNeeded.toFixed(1);
        
        let ratioText = "1 : -"; 
        if (orders > 0 && orgNeeded > 0) { 
            const ratioVal = orgNeeded / orders; 
            ratioText = `1 : ${ratioVal.toFixed(1)}`; 
        } else if (orders === 0 && orgNeeded > 0) { 
            ratioText = "0 : 1"; 
        } 
        $('mix_ratio_display').innerText = ratioText;
        
        if (orgNeeded < 0) { 
            orgEl.style.color = "#e67e22"; 
            $('mix_feasibility_msg').innerText = "🔥 注意：当前预算带来的广告单量已超过总销售目标，请检查预算是否设置过高或目标过低。"; 
        } else { 
            orgEl.style.color = "#27ae60"; 
            $('mix_feasibility_msg').innerText = "✅ 模型健康：自然/广告流量配比在合理区间。"; 
            $('mix_feasibility_msg').style.color = "#27ae60"; 
        }
    }

    function calcAdsFull(price, fixedCost, commRate) {
        if (price <= 0) return; 
        const budget = parse('ads_budget'); 
        const cpc = parse('ads_cpc'); 
        const cvr = parse('ads_cvr') / 100; 
        
        if (cpc <= 0 || cvr <= 0) return;
        
        const unitCostWithComm = fixedCost + (price * commRate); 
        const grossProfitPreAds = price - unitCostWithComm; 
        const clicks = budget / cpc; 
        const orders = clicks * cvr; 
        const totalSales = orders * price; 
        const totalProductCost = orders * unitCostWithComm; 
        const acos = totalSales > 0 ? (budget / totalSales) : 0; 
        const dailyNetProfit = totalSales - totalProductCost - budget; 
        const beCPC = grossProfitPreAds * cvr;
        
        $('ad_unit_price').innerText = fmtUSD(price); 
        $('ad_unit_cost').innerText = fmtUSD(unitCostWithComm); 
        $('ad_unit_profit').innerText = fmtUSD(grossProfitPreAds); 
        $('ad_clicks').innerText = clicks.toFixed(0); 
        $('ad_orders').innerText = orders.toFixed(1); 
        $('ad_total_sales').innerText = fmtUSD(totalSales); 
        $('ad_total_cost').innerText = fmtUSD(totalProductCost); 
        $('ad_be_cpc').innerText = fmtUSD(beCPC); 
        $('ad_acos').innerText = fmtPct2(acos); 
        $('ad_net_profit').innerText = fmtUSD(dailyNetProfit);
    }

    function renderSensitivityMatrix(basePrice, baseCpc, fixedCost, commRate, cvr) {
        const container = $('matrix_container');
        if (basePrice <= 0 || cvr <= 0) {
            container.innerHTML = '<div style="padding:20px; color:#aaa;">请先完善 Plan B 价格及广告 CVR 设置</div>'; return;
        }

        const modeRadios = document.getElementsByName('sens_mode');
        let mode = 'profit'; 
        for(let r of modeRadios) if(r.checked) mode = r.value;

        const pSteps = [ basePrice - 2.0, basePrice - 1.0, basePrice, basePrice + 1.0, basePrice + 2.0 ];
        const cSteps = [ baseCpc + 0.2, baseCpc + 0.1, baseCpc, baseCpc - 0.1, baseCpc - 0.2 ];

        let html = '<table class="sens-table"><thead><tr><th class="sens-corner"></th>';
        pSteps.forEach(p => { let label = "$" + p.toFixed(2); if (Math.abs(p - basePrice) < 0.01) label += " (当前)"; html += `<th>${label}</th>`; });
        html += '</tr></thead><tbody>';

        cSteps.forEach(c => {
            if (c < 0.01) return;
            let label = "$" + c.toFixed(2); if (Math.abs(c - baseCpc) < 0.01) label += " (当前)";
            html += `<tr><th style="min-width:80px;">${label}</th>`;
            pSteps.forEach(p => {
                if (p <= 0) { html += '<td>-</td>'; return; }
                let comm = p * commRate; 
                let cpa = c / cvr; 
                let net = p - fixedCost - comm - cpa;
                let totalCost = fixedCost + comm + cpa; // Approx total cost per unit sold via ads
                
                let valStr = "";
                let colorKey = 0; // Use a normalized score for coloring
                
                if (mode === 'profit') {
                    valStr = (net < 0 ? "-" : "") + "$" + Math.abs(net).toFixed(2);
                    colorKey = net;
                } else if (mode === 'margin') {
                    let margin = (net / p) * 100;
                    valStr = margin.toFixed(1) + "%";
                    colorKey = (margin / 100) * p; 
                } else if (mode === 'roi') {
                    let roi = totalCost > 0 ? (net / totalCost) * 100 : 0;
                    valStr = roi.toFixed(0) + "%";
                    // Map ROI to color key: >30% is great (2.0), 0% is 0.
                    colorKey = (roi / 15); 
                }

                let bg = "#fff"; let color = "#333";
                // Color Logic
                if (colorKey >= 2.0) { bg = "#0277bd"; color = "#fff"; } // Great
                else if (colorKey > 0) { bg = "#4fc3f7"; color = "#000"; } // Good
                else if (Math.abs(colorKey) < 0.01) { bg = "#e1f5fe"; color = "#000"; } // Break Even
                else if (colorKey > -1.0) { bg = "#ffccbc"; color = "#000"; } // Loss
                else { bg = "#d84315"; color = "#fff"; } // Big Loss
                
                html += `<td style="background:${bg}; color:${color}; font-weight:bold;">${valStr}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function doAutoSave() {
        const data = {};
        DATA_FIELDS.forEach(id => { const el = $(id); if(el) data[id] = el.value; });
        data['chk_auto_comm'] = $('chk_auto_comm').checked;
        data['product_name'] = $('product_name').value;
        data['goalState'] = goalState;
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
        const now = new Date();
        const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
        const statusEl = $('autosave_status');
        if(statusEl) statusEl.innerText = `已于 ${timeStr} 自动保存`;
    }

    function loadAutoSave() {
        const str = localStorage.getItem(AUTOSAVE_KEY);
        if(str) {
            const data = JSON.parse(str);
            DATA_FIELDS.forEach(id => { if(data[id]!==undefined && $(id)) $(id).value = data[id]; });
            if(data['chk_auto_comm']!==undefined) $('chk_auto_comm').checked = data['chk_auto_comm'];
            if(data['product_name']!==undefined) $('product_name').value = data['product_name'];
            if(data['goalState']) {
                goalState = data['goalState'];
                // Restore Time Mode UI
                if(goalState.mode === 'month') {
                    $('btn_month').style.background = '#f57f17'; $('btn_month').style.color = '#fff';
                    $('btn_day').style.background = 'transparent'; $('btn_day').style.color = '#f57f17';
                    $('goal_units').value = goalState.month_val;
                } else {
                    $('btn_day').style.background = '#f57f17'; $('btn_day').style.color = '#fff';
                    $('btn_month').style.background = 'transparent'; $('btn_month').style.color = '#f57f17';
                    $('goal_units').value = goalState.day_val;
                }
            } else { setTimeMode('month'); }
            updateCommState();
        }
    }

    function smartInitPrice() {
        // Run calculation once to populate basic fields
        calculate(); 
        const planA_Price_El = $('res_target_price');
        if(!planA_Price_El) return;
        
        const planA_Price = parseFloat(planA_Price_El.innerText.replace('$','')) || 0;
        const currentB = parse('inp_actual_price');
        if (currentB === 0 && planA_Price > 0) {
            $('inp_actual_price').value = planA_Price.toFixed(2);
            calculate(); 
        }
    }

    function setTimeMode(mode) {
        const currentInput = parse('goal_units');
        if(goalState.mode === 'month') goalState.month_val = currentInput;
        else goalState.day_val = currentInput;

        goalState.mode = mode;
        
        if(mode === 'month') {
            $('btn_month').style.background = '#f57f17'; $('btn_month').style.color = '#fff';
            $('btn_day').style.background = 'transparent'; $('btn_day').style.color = '#f57f17';
            $('goal_units').value = goalState.month_val;
        } else {
            $('btn_day').style.background = '#f57f17'; $('btn_day').style.color = '#fff';
            $('btn_month').style.background = 'transparent'; $('btn_month').style.color = '#f57f17';
            $('goal_units').value = goalState.day_val;
        }
        
        calculate();
        doAutoSave(); 
    }

    function smartClear() {
        $('product_name').value = '';
        $('inp_purchase').value = '0';
        $('inp_freight').value = '0';
        $('inp_fba').value = '0';
        $('inp_other').value = '0';
        $('inp_actual_price').value = '0'; 
        localStorage.setItem(SNAPSHOT_KEY, '[]'); 
        renderGoalSnapshots();
        goalState = { mode: 'month', month_val: 0, day_val: 0 };
        setTimeMode('month');
        smartInitPrice();
        $('product_name').focus();
        if($('autosave_status')) $('autosave_status').innerText = '🆕 已清空';
        resetSensCVR();
    }

    function getDB() { return JSON.parse(localStorage.getItem(DB_KEY) || '{}'); }
    function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function saveProduct() {
        const name = $('product_name').value.trim();
        if (!name) { alert('请先输入产品名称！'); return; }
        const db = getDB();
        const data = {};
        DATA_FIELDS.forEach(id => { const el = $(id); if(el) data[id] = el.value; });
        data['chk_auto_comm'] = $('chk_auto_comm').checked;
        data['goalState'] = goalState; 
        data['snap_unit_net_profit'] = $('raw_plan_b_profit').value; 
        data['snap_margin'] = $('txt_actual_margin').innerText;
        data['snap_target_price'] = $('res_target_price').innerText;
        data['snap_ads_budget'] = $('ads_budget').value;
        data['snap_ads_cpc'] = $('ads_cpc').value;
        data['snap_ads_acos'] = $('ad_acos').innerText;
        db[name] = data;
        saveDB(db);
        renderComparisonTable();
        alert(`✅ [${name}] 已保存`);
        doAutoSave();
    }

    function deleteProduct(name) {
        if (confirm(`确定删除 [${name}] 吗？`)) {
            const db = getDB(); delete db[name]; saveDB(db); renderComparisonTable();
            if ($('product_name').value === name) smartClear();
        }
    }

    function loadProduct(name) {
        const db = getDB(); const data = db[name];
        if (!data) return;
        DATA_FIELDS.forEach(id => { if(data[id]!==undefined && $(id)) $(id).value = data[id]; });
        if(data['chk_auto_comm']!==undefined) $('chk_auto_comm').checked = data['chk_auto_comm'];
        $('product_name').value = name;
        if(data['goalState']) {
            goalState = data['goalState'];
            setTimeMode(goalState.mode);
        }
        updateCommState(); calculate();
        resetSensCVR(); 
        
        // Trigger Mix Tab
        if(document.getElementById('tab_mix').classList.contains('active')) {
             updateMixTab();
        }
        // Trigger Promo Tab
        if(document.getElementById('tab_promo').classList.contains('active')) {
             calcPromoTab();
        }
    }

    function renderComparisonTable() {
        const db = getDB();
        const tbody = $('comp_tbody');
        const datalist = $('history_list');
        if(!tbody || !datalist) return;

        tbody.innerHTML = '';
        datalist.innerHTML = ''; 
        const names = Object.keys(db).sort();
        if (names.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px; color:#999;">暂无数据</td></tr>'; return; }
        names.forEach(name => {
            const d = db[name];
            const profitVal = parseFloat(d.snap_unit_net_profit) || 0;
            const profitColor = profitVal > 0 ? '#27ae60' : '#e74c3c';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:8px 10px; border-bottom:1px solid #eee;">${name}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">¥${d.inp_purchase}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">${d.snap_target_price}</td>
                <td style="text-align:center; font-weight:bold; border-bottom:1px solid #eee;">$${d.inp_actual_price}</td>
                <td style="text-align:center; color:${profitColor}; border-bottom:1px solid #eee;">$${parseFloat(d.snap_unit_net_profit).toFixed(2)}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">${d.snap_margin}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">$${d.snap_ads_budget}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">$${d.snap_ads_cpc}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">${d.snap_ads_acos}</td>
                <td style="text-align:center; border-bottom:1px solid #eee;">
                    <button class="btn-load" onclick="loadProduct('${name}')" style="border:1px solid #3498db; color:#3498db; background:#fff; border-radius:4px; cursor:pointer;">载入</button>
                    <button class="btn-del-row" onclick="deleteProduct('${name}')" style="border:none; background:none; color:#ccc; cursor:pointer;">×</button>
                </td>`;
            tbody.appendChild(tr);
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
        });
    }

    function exportCSV() {
        const db = getDB(); const names = Object.keys(db);
        if (names.length === 0) { alert('没有数据'); return; }
        let csv = "\uFEFF产品名称,采购价(¥),建议售价($),实际售价($),单品净利($),利润率(%),广告预算($),CPC($),ACOS(%)\n";
        names.forEach(name => {
            const d = db[name];
            csv += `${name},${d.inp_purchase},${d.snap_target_price.replace('$','')},${d.inp_actual_price},${parseFloat(d.snap_unit_net_profit).toFixed(2)},${d.snap_margin.replace('%','')},${d.snap_ads_budget},${d.snap_ads_cpc},${d.snap_ads_acos.replace('%','')}\n`;
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = "amazon_analysis_v22.csv";
        link.click();
    }

    // --- EVENT LISTENERS ---
    
    // Goal Units listener
    if($('goal_units')) {
        $('goal_units').addEventListener('input', function() {
            const val = parse('goal_units');
            if(goalState.mode === 'month') goalState.month_val = val;
            else goalState.day_val = val;
            calculate();
        });
    }

    updateCommState();
</script>
</body>
</html>